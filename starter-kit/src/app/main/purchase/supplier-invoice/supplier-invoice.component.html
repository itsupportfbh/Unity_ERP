<div class="pinX">
  <!-- Top bar -->
  <div class="pinX__topbar">
    <button type="button" class="pinX__back" (click)="goToSupplierInvoice()">
      <i class="fas fa-arrow-left"></i>
      <span>Supplier Invoice List</span>
    </button>

    <div class="pinX__topRight">
      <span class="pinX__pill">
        <i class="fas fa-link"></i>
        3-way match: PO · GRN · PIN
      </span>

      <button type="button" class="pinX__btn pinX__btn--brand" (click)="openOcr()">
        <i class="fas fa-file-upload"></i>
        <span>OCR Upload</span>
      </button>
    </div>
  </div>

  <form class="ui-compact" [formGroup]="form">
    <div class="pinX__wrap">
      <div class="pinX__card">

        <!-- Header -->
        <div class="pinX__head">
          <div>
            <h2 class="pinX__title">Supplier Invoice (PIN)</h2>
            <div class="pinX__sub">
              Select GRN → auto-fill Supplier / Tax / Lines → verify totals → Save
            </div>
          </div>

          <div class="pinX__summary">
            <div class="pinX__sumItem">
              <div class="k">Sub-total</div>
              <div class="v">{{ subTotal | number:'1.2-2' }}</div>
            </div>
            <div class="pinX__sumItem">
              <div class="k">Tax</div>
              <div class="v">{{ taxAmount | number:'1.2-2' }}</div>
            </div>
            <div class="pinX__sumItem pinX__sumItem--strong">
              <div class="k">Net Payable</div>
              <div class="v">{{ netPayable | number:'1.2-2' }}</div>
            </div>
          </div>
        </div>

        <!-- Header fields -->
        <div class="pinX__section">
          <div class="pinX__grid">
            <!-- GRN combobox -->
            <div class="pinX__field pinX__field--grn grn-combobox">
              <label class="pinX__label">GRN #</label>

              <div class="pinX__combo">
                <input
                  type="text"
                  class="pinX__input pinX__input--withCaret"
                  [value]="grnSearch"
                  (input)="onGrnSearch($event)"
                  (focus)="onGrnFocus()"
                  placeholder="Search GRN…"
                  [attr.aria-expanded]="grnOpen"
                />

                <button
                  type="button"
                  class="pinX__caretBtn"
                  (click)="grnOpen = !grnOpen"
                  aria-label="Toggle GRN list"
                >
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>

              <input type="hidden" formControlName="grnId" />
              <input type="hidden" formControlName="grnNo" />

              <div *ngIf="grnOpen" class="pinX__dropdown">
                <div class="pinX__dropHead">Choose GRN</div>

                <button
                  type="button"
                  class="pinX__dropItemOneLine"
                  *ngFor="let g of grnFiltered; trackBy: trackByLine"
                  (click)="selectGrn(g)"
                >
                  <span class="xNo">{{ g.grnNo }}</span>
                  <span class="xSep">•</span>
                  <span class="xSup">{{ g.supplierName || '-' }}</span>
                  <span class="xSep" *ngIf="g.poNo">•</span>
                  <span class="xPo" *ngIf="g.poNo">PO: {{ g.poNo }}</span>
                </button>

                <div *ngIf="!grnFiltered?.length" class="pinX__dropEmpty">No results</div>
              </div>
            </div>

            <!-- Supplier -->
            <div class="pinX__field">
              <label class="pinX__label">Supplier</label>
              <input type="text" class="pinX__input pinX__input--readonly" formControlName="supplierName" readonly />
            </div>

            <!-- Invoice Date -->
            <div class="pinX__field">
              <label class="pinX__label">Invoice Date</label>
              <input type="date" class="pinX__input" [min]="minDate" formControlName="invoiceDate" />
            </div>

            <!-- Amount -->
            <div class="pinX__field">
              <label class="pinX__label">Amount</label>
              <input type="number" class="pinX__input pinX__input--readonly" formControlName="amount" [readonly]="true" />
            </div>

            <!-- Tax -->
            <div class="pinX__field">
              <label class="pinX__label">Tax</label>

              <div class="pinX__taxRow">
                <select class="pinX__input pinX__select" formControlName="taxMode" (change)="onTaxModeChange()">
                  <option value="EXCLUSIVE">Exclusive</option>
                  <option value="INCLUSIVE">Inclusive</option>
                  <option value="ZERO">0% (No tax)</option>
                </select>

                <div class="pinX__taxPct">
                  <input type="number"
                         class="pinX__input"
                         formControlName="tax"
                         [readonly]="taxMode === 'ZERO'"
                         (input)="onTaxChange()"
                         placeholder="%" />
                  <span class="pinX__suffix">%</span>
                </div>
              </div>

              <div class="pinX__hint">
                Mode: <b>{{ taxMode }}</b>
              </div>
            </div>
          </div>
        </div>

        <!-- Lines -->
        <div class="pinX__section">
          <div class="pinX__sectionHead">
            <div class="pinX__sectionTitle">
              <i class="fas fa-list"></i> Lines
            </div>

            <!-- <div class="pinX__scrollHint">
              <i class="fas fa-arrows-left-right"></i> Scroll →
            </div> -->
          </div>

          <!-- ✅ scroll container (NO overlay inside) -->
          <div class="pinX__tableScroll">
            <div class="pinX__tableShell">

              <div class="pinX__tableWrap pinX__tableFixed">
                <!-- Header -->
                <div class="pinX__tableHead pinX__rowFixed">
                  <div class="c1">Item</div>
                  <div class="c2">Ledger Name</div>
                  <div class="c3">Location</div>
                  <div class="c4">Qty</div>
                  <div class="c5">Unit Price</div>
                  <div class="c6">Discount %</div>
                  <div class="c7 tR">Total</div>
                </div>

                <div formArrayName="lines">
                  <div *ngIf="lines.length === 0" class="pinX__empty">No lines yet.</div>

                  <div *ngFor="let row of lines.controls; let i = index; trackBy: trackByLine"
                       [formGroupName]="i"
                       class="pinX__tr pinX__rowFixed">

                    <div class="c1">
                      <input class="pinX__input pinX__cellInput" formControlName="item" />
                    </div>

                    <div class="c2">
                      <ng-select
                        class="pin-budget-select pinX__ngSelect pinX__ngSelect--fixed"
                        [items]="parentHeadList"
                        bindLabel="label"
                        bindValue="value"
                        [searchable]="true"
                        [clearable]="false"
                        placeholder="Search / choose Ledger Name..."
                        formControlName="budgetLineId"
                        appendTo="body"
                        dropdownPosition="bottom"
                      >
                        <ng-template ng-label-tmp let-item="item">
                          <span class="pinX__ngLabel" [title]="item?.label">{{ item?.label }}</span>
                        </ng-template>
                        <ng-template ng-option-tmp let-item="item">
                          <div class="pinX__ngOption" [title]="item.label">{{ item.label }}</div>
                        </ng-template>
                      </ng-select>
                    </div>

                    <div class="c3">
                      <input class="pinX__input pinX__cellInput" formControlName="location" />
                    </div>

                    <div class="c4">
                      <input type="number" class="pinX__input pinX__cellInput" formControlName="qty" (input)="onCellChange(i)" />
                    </div>

                    <div class="c5">
                      <input type="number" class="pinX__input pinX__cellInput" formControlName="unitPrice" (input)="onCellChange(i)" />
                    </div>

                    <div class="c6">
                      <input type="number" class="pinX__input pinX__cellInput" formControlName="discountPct" (input)="onCellChange(i)" />
                    </div>

                    <div class="c7 tR pinX__lineTotal">
                      {{ (row.get('lineTotal')?.value || 0) | number:'1.2-2' }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- ✅ fade only OUTSIDE the table area -->
              <!-- <div class="pinX__scrollFadeRight" aria-hidden="true"></div> -->
            </div>
          </div>

          <!-- Totals below -->
          <div class="pinX__totalsBelow">
            <div class="pinX__totalsCard">
              <div class="pinX__totalsTitle">
                <i class="fas fa-calculator"></i> Totals
              </div>

              <div class="pinX__totalsRows">
                <div class="r">
                  <div class="k">Sub-total</div>
                  <div class="v">{{ subTotal | number:'1.2-2' }}</div>
                </div>

                <div class="r">
                  <div class="k">Discount</div>
                  <div class="v">{{ discountTotal | number:'1.2-2' }}</div>
                </div>

                <div class="r">
                  <div class="k">
                    Tax <span class="muted">({{ form.get('tax')?.value || 0 }}% - {{ taxMode }})</span>
                  </div>
                  <div class="v">{{ taxAmount | number:'1.2-2' }}</div>
                </div>

                <div class="r sep"></div>

                <div class="r strong">
                  <div class="k">Grand total</div>
                  <div class="v">{{ grandTotal | number:'1.2-2' }}</div>
                </div>

                <div class="r strong brand">
                  <div class="k">Net Payable</div>
                  <div class="v">{{ netPayable | number:'1.2-2' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="pinX__actions">
          <button class="pinX__btn pinX__btn--primary" type="button" [disabled]="form.invalid" (click)="save('HOLD')">
            <i class="fas fa-save"></i>
            <span>Save</span>
          </button>
        </div>

      </div>
    </div>
  </form>
</div>

<app-ocr-upload-modal
  [open]="ocrOpen"
  [createdBy]="userId"
  (closed)="ocrOpen=false"
  (applied)="onOcrApplied($event)">
</app-ocr-upload-modal>