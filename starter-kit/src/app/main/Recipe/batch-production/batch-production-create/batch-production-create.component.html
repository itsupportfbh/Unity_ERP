<div class="bp2 card">
  <!-- Header row (same feel as your recipe list) -->
  <div class="bp2-head">
  <div class="bp2-head-left">
    <div class="bp2-title">Batch Production Execution</div>
  </div>

  <div class="bp2-actions">
    <button class="bp2-btn primary" type="button" (click)="cancel()">
      <i data-feather="x-circle" class="bp2-ico"></i>
      <span>Cancel</span>
    </button>

    <button class="bp2-btn success"
            type="button"
            (click)="postToInventory()"
            [disabled]="!canPost()">
      <i class="fas fa-check-circle bp2-ico"></i>
      <span>Post &amp; Save to Inventory</span>
    </button>
  </div>
</div>


  <!-- Filters -->
  <div class="bp2-bar">
    <div class="bp2-field">
      <label class="bp2-label">Select Plan</label>

      <select class="bp2-select"
              [(ngModel)]="selectedPlanId"
              (change)="onPlanChange()">
        <option [ngValue]="null">-- Select Plan --</option>
      <option *ngFor="let p of plans" [ngValue]="p.id">
        {{ p.label }}
      </option>
      </select>

      <div class="bp2-loading" *ngIf="isLoading">Loading…</div>
    </div>

    <div class="bp2-kpis">
      <div class="bp2-kpi">
        <div class="k-lbl">Recipes</div>
        <div class="k-val">{{ lines.length || 0 }}</div>
      </div>

      <div class="bp2-kpi warn">
        <div class="k-lbl">Variance Items</div>
        <div class="k-val">{{ varianceCount }}</div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="bp2-tablewrap">
    <table class="bp2-table">
      <thead>
        <tr>
          <th style="width:50%;">Recipe</th>
          <th class="num" style="width:16%;">Planned</th>
          <th class="num" style="width:18%;">Actual Produced</th>
          <th class="num" style="width:16%;">Variance</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngIf="!lines.length">
          <td colspan="4" class="bp2-empty">Select Plan to load recipes…</td>
        </tr>

        <tr *ngFor="let r of lines; let i = index">
          <td (click)="openIngredients(r)">
            <div class="bp2-main">{{ r.recipeName }}</div>
            <div class="bp2-mini">{{ r.uom || 'UOM' }}</div>
          </td>

          <td class="num">
            <span class="bp2-chip">{{ fmt(r.plannedQty) }}</span>
          </td>

          <td class="num">
            <input type="number"
                   class="bp2-input"
                   [ngModel]="r.actualQty"
                   (ngModelChange)="onActualChange(i, $event)"
                   min="0"
                   step="0.001" />
          </td>

          <td class="num">
            <span class="bp2-badge"
                  [ngClass]="getVarClass(r)">
              {{ fmt((r.actualQty ?? 0) - (r.plannedQty ?? 0)) }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>


</div>

<div class="bp2-modal" *ngIf="ingredientOpen">
  <div class="bp2-modal-card">
    <div class="bp2-modal-head">
      <div class="bp2-modal-title">{{ ingredientTitle }}</div>
      <button class="bp2-x" type="button" (click)="closeIngredients()">✕</button>
    </div>

    <div class="bp2-modal-body">
      <div *ngIf="ingredientLoading" class="bp2-empty">Loading…</div>

      <table class="bp2-table" *ngIf="!ingredientLoading">
        <thead>
          <tr>
            <th>Ingredient</th>
            <th class="num">Required</th>
            <th class="num">Available</th>
            <th>Status</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngIf="!ingredientRows.length">
            <td colspan="4" class="bp2-empty">No ingredients</td>
          </tr>

          <tr *ngFor="let x of ingredientRows">
            <td>{{ x.ingredientName }}</td>
            <td class="num">{{ fmt(x.requiredQty) }}</td>
            <td class="num">{{ fmt(x.availableQty) }}</td>
            <td>
              <span class="bp2-pill" [ngClass]="x.status === 'Shortage' ? 'bad' : 'good'">
                {{ x.status }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>



