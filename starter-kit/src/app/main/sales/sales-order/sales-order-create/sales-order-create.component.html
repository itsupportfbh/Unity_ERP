<button
  (click)="goToList()"
  class="btn mb-2 position-relative d-flex align-items-center justify-content-center"
  style="background-color:#2E5F73; color:white; padding-left:2.25rem;"
>
  <i
    class="fas fa-arrow-left position-absolute"
    style="left:0.75rem; top:50%; transform:translateY(-50%);"
    aria-hidden="true"
  ></i>
  <span>Go to SalesOrder list</span>
</button>

<div class="so-page pr-typography">
  <div class="bg-white rounded-2xl shadow px-3 pt-3 pb-6 border border-gray-100 so-card">

    <!-- Header -->
    <div class="so-head">
      <h2 class="title">{{ editMode ? 'Edit Sales Order' : 'Sales Order' }}</h2>
    </div>

    <!-- Header fields -->
    <div [ngClass]="gridColsClass(4)" class="so-grid">

      <!-- Quotation -->
      <div class="so-header-dd dropdown-input">
        <label class="lbl">Quotation No</label>
        <div class="relative">
          <input type="text" class="so-inp"
                 [(ngModel)]="searchTexts['quotationNo']"
                 (input)="!editMode && filter('quotationNo')"
                 (focus)="!editMode && toggleDropdown('quotationNo', true)"
                 placeholder="Search Quotation No..."
                 [disabled]="editMode" />

          <button *ngIf="searchTexts['quotationNo'] && !editMode" type="button"
                  (click)="onClearSearch('quotationNo')" class="btn-clear">✕</button>

          <button type="button"
                  (click)="!editMode && toggleDropdown('quotationNo')"
                  class="btn-caret" [disabled]="editMode">▼</button>
        </div>

        <ul *ngIf="dropdownOpen['quotationNo'] && !editMode" class="dropdown">
          <li *ngFor="let c of filteredLists['quotationNo']" (click)="select('quotationNo', c)">
            {{ c.number }}
          </li>
        </ul>
      </div>

      <!-- Customer -->
      <div class="so-header-dd">
        <label class="lbl">Customer</label>
        <input type="text" class="so-inp" disabled [(ngModel)]="searchTexts['customer']" />
      </div>

      <!-- Source Line (readonly) -->
      <div>
        <label class="lbl">Source Line</label>
        <input class="so-inp" type="text" [value]="sourceLineText" disabled />
      </div>

      <!-- Item Set chips -->
      <div *ngIf="showItemSetBox" class="md:col-span-2">
        <label class="lbl">Item Set Name</label>
        <div class="so-inp so-chipbox" title="{{ itemSetNamesText }}">
          <ng-container *ngIf="soHdr.itemSets?.length; else noItemSet">
            <span class="so-chip" *ngFor="let s of soHdr.itemSets">{{ s.name }}</span>
          </ng-container>
          <ng-template #noItemSet><span class="dim">—</span></ng-template>
        </div>
      </div>

      <!-- GST -->
      <div>
        <label class="lbl">GST (%)</label>
        <input class="so-inp" type="text" disabled [(ngModel)]="soHdr.gstPct"/>
      </div>

      <!-- Requested Date -->
      <div>
        <label class="lbl">Requested Date</label>
        <input class="so-inp so-inp-readonly"
               type="date"
               [(ngModel)]="soHdr.requestedDate"
               [min]="todayStr"
               disabled
               [ngModelOptions]="{ standalone: true }" />
      </div>

      <!-- Delivery Date -->
      <div class="col-span-1 md:col-span-1">
        <label class="lbl">Delivery Date</label>
        <input class="so-inp"
               type="date"
               [(ngModel)]="soHdr.deliveryDate"
               [ngModelOptions]="{ standalone: true }"
               readonly />
      </div>

      <!-- Delivery To -->
      <div class="md:col-span-2">
        <label class="lbl">Delivery To</label>
        <textarea class="so-inp so-textarea"
                  rows="3"
                  [(ngModel)]="soHdr.deliveryTo"
                  placeholder="Delivery address / site / contact person"></textarea>
      </div>

      <!-- Remarks -->
      <div class="md:col-span-2">
        <label class="lbl">Remarks</label>
        <textarea class="so-inp so-textarea"
                  rows="3"
                  [(ngModel)]="soHdr.remarks"
                  placeholder="Any remarks..."></textarea>
      </div>
    </div>

    <!-- ======================= GROUPED TABLE ======================= -->
  <!-- ======================= GROUPED TABLE (CORRECT) ======================= -->
<div class="table-wrap mt-4">
  <table class="so-table so-table--grouped">
    <thead>
      <tr>
        <th class="col-item">ITEM / SET</th>
        <th class="col-flags">ITEM MASTER FLAGS</th>
        <th class="col-desc">DESCRIPTION</th>
        <th class="col-uom">UOM</th>
        <th class="col-qty num">QTY</th>
        <th class="col-price num">UNIT PRICE</th>
        <th class="col-disc num">DISCOUNT %</th>
        <th class="col-tax">TAX MODE</th>

        <!-- <th class="col-fulfill">FULFILLMENT</th> -->
        <th class="col-supply">SUPPLY METHOD (SO)</th>

        <th class="col-total num">LINE TOTAL</th>
        <th class="col-act text-right">ACTION</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngIf="!setGroups?.length">
        <td class="empty" colspan="12">No lines yet.</td>
      </tr>

      <ng-container *ngFor="let g of setGroups">

        <!-- SET HEADER -->
        <tr class="set-row">
          <td class="set-cell" colspan="11">
            <div class="set-left">
              <span class="set-ico"><i class="fas fa-layer-group"></i></span>
              <span class="set-name">{{ g.name }}</span>
            </div>
          </td>

          <td class="set-action text-right">
            <button type="button" class="btn-set-remove" (click)="removeSet(g)">
              <i class="fas fa-trash"></i> Remove
            </button>
          </td>
        </tr>

        <!-- ITEMS -->
        <tr class="item-row" *ngFor="let ln of g.lines; trackBy: trackByLineId">

          <td class="td-item">
            <div class="item-text">{{ ln.item }}</div>
          </td>

          <!-- FLAGS -->
          <td class="td-flags">
            <div class="flag-line">
              <span class="k">Sellable:</span>
              <span class="v" [class.yes]="ln.isSellable" [class.no]="ln.isSellable===false">
                {{ ln.isSellable ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="flag-line">
              <span class="k">Consumable:</span>
              <span class="v" [class.yes]="ln.isConsumable" [class.no]="ln.isConsumable===false">
                {{ ln.isConsumable ? 'Yes' : 'No' }}
              </span>
            </div>
          </td>

          <td>
            <input class="so-inp so-inp--line"
                   [(ngModel)]="ln.description"
                   placeholder="-"
                   (input)="computeTotals()" />
          </td>

          <td>
            <input class="so-inp so-inp--line so-inp--uom"
                   [(ngModel)]="ln.uom"
                   placeholder="UOM"
                   [disabled]="editMode" />
          </td>

          <td class="num">
            <input type="number"
                   class="so-inp so-inp--line so-inp--qty text-right"
                   [(ngModel)]="ln.qty"
                   (input)="computeTotals()" />
          </td>

          <td class="num">
            <input type="number"
                   class="so-inp so-inp--line so-inp--price text-right"
                   [(ngModel)]="ln.unitPrice"
                   (input)="computeTotals()"
                   min="0" step="0.01" />
          </td>

          <td class="num">
            <input type="number"
                   class="so-inp so-inp--line so-inp--disc text-right"
                   [(ngModel)]="ln.discountPct"
                   (input)="computeTotals()"
                   placeholder="0" />
          </td>

          <td>
            <div class="tax-dd">
              <select class="so-inp so-inp--line so-inp--tax"
                      [(ngModel)]="ln.taxMode"
                      (change)="computeTotals()">
                <option *ngFor="let m of taxModesForCurrentGst" [ngValue]="m">{{ m }}</option>
              </select>
              <span class="tax-caret">▾</span>
            </div>
          </td>

          <!-- Fulfillment (readonly label) -->
          <!-- <td class="td-fulfill">
            <div class="badge-pill"
                 [class.badge-sell]="ln.fulfillmentMode===1"
                 [class.badge-cons]="ln.fulfillmentMode===2"
                 [class.badge-both]="ln.fulfillmentMode===3"
                 [class.badge-none]="ln.fulfillmentMode==null">
              {{ getFulfillmentLabel(ln.fulfillmentMode) }}
            </div>
          </td> -->

          <!-- SupplyMethod -->
          <td class="td-supply">
            <div class="tax-dd">
              <select class="so-inp so-inp--line"
                      [(ngModel)]="ln.supplyMethod"
                      [disabled]="ln.__supplyLocked"
                      (change)="onSupplyMethodChangedByRef(ln)">
                <option [ngValue]="null">SELECT</option>
               
                <option [ngValue]="1">PP</option>
                 <option [ngValue]="2">DIRECT DO</option>
              </select>
              <span class="tax-caret">▾</span>
            </div>

            <div class="muted-mini">
              {{ getSupplyLabel(ln.supplyMethod) }}
              <span *ngIf="ln.__supplyLocked" class="lock-mini">• Auto</span>
            </div>

            <div *ngIf="ln.fulfillmentMode===3 && (ln.supplyMethod===null || ln.supplyMethod===undefined)" class="warn-mini">
              Both item → choose Direct DO / PP
            </div>
          </td>

          <td class="num">
            <span class="line-total">{{ (ln.lineTotal || 0) | number:'1.2-2' }}</span>
          </td>

          <td class="text-right">
            <button type="button" class="btn-icon-trash" (click)="removeLineFromSet(g, ln)" aria-label="Remove line">
              <i class="fas fa-trash"></i>
            </button>
          </td>

        </tr>

      </ng-container>
    </tbody>
  </table>
</div>
    <!-- Summary -->
    <div class="sum-grid">
      <div class="sum-grid-spacer"></div>

      <aside class="mini-total-card mtc-spaced">
        <div class="mtc-row">
          <span class="mtc-label">Sub Total</span>
          <input class="so-inp mtc-inp text-right" type="text"
                 [value]="(totals.subTotal || 0) | number:'1.2-2'" readonly>
        </div>

        <div class="mtc-row">
          <span class="mtc-label">Tax (GST)</span>
          <input class="so-inp mtc-inp text-right" type="text"
                 [value]="(totals.gstAmount || 0) | number:'1.2-2'" readonly>
        </div>

        <div class="mtc-row">
          <span class="mtc-label">Net Total</span>
          <span class="mtc-amt">{{ totals.netTotal | number:'1.2-2' }}</span>
        </div>
      </aside>
    </div>

  </div>

  <div class="sticky-actions">
    <div class="container">
      <button type="button" class="so-btn so-btn-primary" (click)="post()">
        {{ editMode ? 'Update' : 'Save' }}
      </button>

      <button type="button" class="so-btn so-btn-danger" (click)="cancel()">
        Cancel
      </button>
    </div>
  </div>
</div>