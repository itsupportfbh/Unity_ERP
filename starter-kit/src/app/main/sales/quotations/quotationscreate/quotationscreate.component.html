<!-- quotationscreate.component.html -->

<!-- Back button (SMALL) -->
<button (click)="goToList()" class="qtBackBtnSm" type="button">
  <i class="fas fa-arrow-left" aria-hidden="true"></i>
  <span>Go to QT list</span>
</button>

<div class="qtPage ui-compact pr-typography">

  <!-- ===== Header Card ===== -->
  <div class="qtCard">
    <div class="qtCard__top">
      <div class="qtTitle">
        <div class="qtTitle__badge">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="qtTitle__txt">
          <h2>Quotation (QT)</h2>
          <div class="qtTitle__sub">Create / Edit quotation with items & item sets</div>
        </div>
      </div>

      <div class="qtTopRight">
        <span class="qtPill">
          <span class="k">Status</span>
          <span class="v">{{ statusLabel(header.status) }}</span>
        </span>

        <span class="qtHint" *ngIf="header.needsHodApproval">
          <i class="fas fa-circle-info"></i>
          Discounts above 10% need HOD approval
        </span>
      </div>
    </div>

    <!-- ===== Header Form Grid ===== -->
    <div class="qtForm">

      <!-- Row 1 -->
      <div class="qtGrid4">
        <!-- Customer -->
        <div class="qtField">
          <label class="qtLabel">Customer</label>
          <div class="qtControl position-relative" #customerBox>
            <input
              type="text"
              class="form-control qtInput"
              placeholder="Search customer..."
              [(ngModel)]="customerSearch"
              name="customerSearch"
              autocomplete="off"
              (focus)="openCustomerDropdown()"
              (input)="filterCustomers()" />

            <div *ngIf="customerDdOpen" class="qtMenu">
              <div
                class="qtMi qtMi--split"
                *ngFor="let c of filteredCustomers"
                (mousedown)="$event.preventDefault()"
                (click)="selectCustomer(c)">
                <span class="truncate">{{ c.name }}</span>
              </div>
              <div class="qtMi qtMi--muted" *ngIf="!filteredCustomers?.length">No results</div>
            </div>
          </div>
        </div>

        <!-- Delivery Date -->
        <div class="qtField">
          <label class="qtLabel">Delivery Date</label>
          <input
            #dateInput
            type="date"
            class="form-control qtInput"
            [(ngModel)]="header.deliveryDate"
            name="deliveryDate"
            [min]="minDate"
            (click)="dateInput.showPicker?.()"
            (focus)="dateInput.showPicker?.()"
            inputmode="none"
            autocomplete="off" />
        </div>

        <!-- Currency -->
        <div class="qtField">
          <label class="qtLabel">Currency</label>
          <div class="qtControl position-relative" #currencyBox>
            <input
              type="text"
              class="form-control qtInput"
              placeholder="Type to search currency..."
              [(ngModel)]="currencySearch"
              name="currencySearch"
              autocomplete="off"
              (focus)="openCurrencyDropdown()"
              (input)="filterCurrencies()" />

            <div *ngIf="currencyDdOpen" class="qtMenu">
              <div
                class="qtMi"
                *ngFor="let cur of filteredCurrencies"
                (mousedown)="$event.preventDefault()"
                (click)="selectCurrency(cur)">
                {{ cur.name }}
              </div>
              <div class="qtMi qtMi--muted" *ngIf="!filteredCurrencies?.length">No results</div>
            </div>
          </div>
        </div>

        <!-- FX Rate -->
        <div class="qtField">
          <label class="qtLabel">FX Rate</label>
          <input
            type="number"
            class="form-control qtInput"
            [(ngModel)]="header.fxRate"
            name="fxRate"
            step="0.000001" />
        </div>
      </div>

      <!-- Row 2 -->
      <div class="qtGrid4">
        <!-- Line Source -->
        <div class="qtField">
          <label class="qtLabel">Line Source</label>
          <select
            class="form-control qtInput"
            [(ngModel)]="header.lineSourceId"
            name="lineSourceId"
            (change)="onLineSourceChange()">
            <option [ngValue]="1">Individual Item</option>
            <option [ngValue]="2">Item Set</option>
            <option [ngValue]="3">Mixed (Item + Set)</option>
          </select>
        </div>

        <!-- Payment Terms -->
        <div class="qtField">
          <label class="qtLabel">Payment Terms</label>
          <div class="qtControl position-relative" #paymentBox>
            <input
              type="text"
              class="form-control qtInput"
              placeholder="Search payment terms..."
              [(ngModel)]="paymentTermsSearch"
              name="paymentTermsSearch"
              autocomplete="off"
              (focus)="openPaymentTermsDropdown()"
              (input)="filterPaymentTerms()" />

            <div *ngIf="paymentTermsDdOpen" class="qtMenu">
              <div
                class="qtMi"
                *ngFor="let p of filteredPaymentTerms"
                (mousedown)="$event.preventDefault()"
                (click)="selectPaymentTerms(p)">
                {{ p.name }}
              </div>
              <div class="qtMi qtMi--muted" *ngIf="!filteredPaymentTerms?.length">No results</div>
            </div>
          </div>
        </div>

        <!-- GST% -->
        <div class="qtField">
          <label class="qtLabel">GST %</label>
          <input
            type="number"
            class="form-control qtInput"
            [(ngModel)]="header.taxPct"
            name="taxPct"
            readonly />
        </div>

        <div class="qtField"></div>
      </div>

      <!-- Row 3: Item Set Multi -->
      <div class="qtGrid2" *ngIf="header.lineSourceId === 2 || header.lineSourceId === 3">
        <div class="qtField">
          <label class="qtLabel">Select Item Set (Multi)</label>

          <div class="qtAddRow">
            <div class="qtControl position-relative flex-grow-1" #itemSetBox>
              <input
                type="text"
                class="form-control qtInput qtInput--withIcon"
                placeholder="Search item set..."
                [(ngModel)]="itemSetSearch"
                name="itemSetSearch"
                autocomplete="off"
                (focus)="openItemSetDropdown()"
                (input)="filterItemSets()" />

              <button type="button" class="qtDropBtn" (click)="toggleItemSetDropdown()">
                <i class="fas fa-chevron-down"></i>
              </button>

              <div *ngIf="itemSetDdOpen" class="qtMenu">
                <div
                  class="qtMi qtMi--split"
                  *ngFor="let s of filteredItemSets; trackBy: trackByItemSetId"
                  (mousedown)="$event.preventDefault()"
                  (click)="selectItemSetCandidate(s)">
                  <span class="truncate">{{ s.setName }}</span>
                  <small class="qtMuted">#{{ s.id }}</small>
                </div>
                <div class="qtMi qtMi--muted" *ngIf="!filteredItemSets?.length">No results</div>
              </div>
            </div>

            <button
              type="button"
              class="qtBtn qtBtn--brand qtBtn--minW"
              (click)="addSelectedItemSet()"
              [disabled]="!pendingItemSet">
              <i class="fas fa-plus"></i>
              Add
            </button>
          </div>

          <!-- Selected item sets -->
          <div class="qtChipWrap" *ngIf="selectedItemSets.length">
            <div class="qtChip" *ngFor="let s of selectedItemSets; trackBy: trackByItemSetId">
              <i class="fas fa-layer-group"></i>
              <span class="t">{{ s.setName }}</span>
              <button type="button" class="x" (click)="removeItemSet(s.id)" aria-label="Remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="qtField">
          <label class="qtLabel">Quick Notes</label>
          <div class="qtInfoBox">
            <div class="qtInfoLine">
              <i class="fas fa-lightbulb"></i>
              <span>Choose set → click <b>Add</b>. Multiple sets can be added.</span>
            </div>
            <div class="qtInfoLine">
              <i class="fas fa-shield-check"></i>
              <span>Item master flags are shown in lines (read-only).</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 4 -->
      <div class="qtGrid2">
        <div class="qtField">
          <label class="qtLabel">Delivery To</label>
          <textarea
            class="form-control qtInput qtTextarea"
            rows="2"
            [(ngModel)]="header.deliveryTo"
            name="deliveryTo"
            placeholder="Enter delivery address / delivery location..."></textarea>
        </div>

        <div class="qtField">
          <label class="qtLabel">Remarks</label>
          <textarea
            class="form-control qtInput qtTextarea"
            rows="2"
            [(ngModel)]="header.remarks"
            name="remarks"
            placeholder="Enter remarks..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Lines Table Card ===== -->
  <div class="qtCard qtCard--lines">

    <div class="qtLinesTop">
      <div class="qtLinesTitle">
        <i class="fas fa-list-check"></i>
        <span>Quotation Lines</span>
      </div>

      <button
        class="qtBtn qtBtn--brand"
        type="button"
        [class.isDisabled]="!(header.lineSourceId === 1 || header.lineSourceId === 3)"
        (click)="openAdd()"
        [disabled]="!(header.lineSourceId === 1 || header.lineSourceId === 3)">
        <i class="fas fa-plus"></i>
        Add line
      </button>
    </div>

    <div class="qtTableWrap">
      <table class="table m-0 align-middle qtTable">
        <thead>
          <tr>
            <th>Item / Set</th>
            <th style="min-width:240px;">Item Master Flags</th>
            <th style="min-width:240px;">Description</th>
            <th style="width:90px;">UOM</th>
            <th class="text-center" style="width:130px;">Qty</th>
            <th class="text-center" style="width:150px;">Unit Price</th>
            <th class="text-center" style="width:140px;">Discount %</th>
            <th style="width:160px;">Tax Mode</th>
            <th style="width:170px;">Fulfillment (SO)</th>
            <th class="text-center" style="width:160px;">Line Total</th>
            <th class="text-center" style="width:110px;">Action</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngIf="lines.length === 0">
            <td class="qtEmpty" [attr.colspan]="11">
              <div class="qtEmptyBox">
                <i class="fas fa-inbox"></i>
                <div class="t1">No lines yet</div>
                <div class="t2">Click <b>Add line</b> to start.</div>
              </div>
            </td>
          </tr>

          <ng-container *ngFor="let l of lines; let i = index">

            <!-- ✅ Set Header Row (3rd image style) -->
            <tr *ngIf="l.isSetHeader" class="qtSetRow">
              <td [attr.colspan]="11">
                <div class="qtSetBar">
                  <div class="qtSetName">
                    <i class="fas fa-layer-group"></i>
                    <span class="qtSetMain">{{ l.setName }}</span>
                    <span class="qtSetTag">SET</span>
                  </div>

                  <button class="qtBtn qtBtn--danger" type="button" (click)="removeItemSet(l.itemSetId!)">
                    <i class="fas fa-trash"></i>
                    Remove Set
                  </button>
                </div>
              </td>
            </tr>

            <!-- Item Row -->
            <tr *ngIf="!l.isSetHeader" class="qtLineRow" [class.qtLineRow--fromSet]="l.isFromSet">

              <!-- Item -->
              <td>
                <div class="qtItemCell">
                  <div class="n">{{ l.itemName || getItemName(l.itemId) || '-' }}</div>

                  <!-- ✅ setName show inside line (like 3rd image) -->
                  <!-- <div class="set" *ngIf="l.isFromSet && (l.setName || l.itemSetId)">
                    <i class="fas fa-layer-group"></i>
                    <span class="t">{{ l.setName || ('Set #' + l.itemSetId) }}</span>
                  </div>

                  <div class="s" *ngIf="l.isFromSet">
                    <i class="fas fa-link"></i> From Item Set
                  </div> -->
                </div>
              </td>

              <!-- Flags -->
              <td class="qtFlagsCell">
                <div class="qtFlags">
                  <span class="qtTag qtTag--ok" *ngIf="l.isSellable === true">Sellable</span>
                  <span class="qtTag qtTag--bad" *ngIf="l.isSellable === false">Not Sellable</span>

                  <span class="qtTag qtTag--ok2" *ngIf="l.isConsumable === true">Consumable</span>
                  <span class="qtTag qtTag--bad2" *ngIf="l.isConsumable === false">Not Consumable</span>

                  <span class="qtTag qtTag--dark" *ngIf="l.allowManualFulfillment">Manual Fulfillment</span>
                </div>

                <!-- <div class="qtMuted small mt-1" *ngIf="l.fulfillmentText">
                  Auto: {{ l.fulfillmentText }}
                </div> -->
              </td>

              <!-- Desc -->
              <td>
                <input class="form-control qtInput qtInput--sm"
                       [(ngModel)]="l.description"
                       (ngModelChange)="onLineChanged(i)"
                       placeholder="-" />
              </td>

              <!-- UOM -->
              <td class="qtUom">{{ getUomName(l.uomId) }}</td>

              <!-- Qty -->
              <td class="text-center">
                <input type="number" class="form-control qtInput qtInput--sm qtNum text-center"
                       [(ngModel)]="l.qty"
                       (ngModelChange)="onLineChanged(i)"
                       min="0" step="0.0001" />
              </td>

              <!-- Unit Price -->
              <td class="text-center">
                <input type="number" class="form-control qtInput qtInput--sm qtNum text-center"
                       [(ngModel)]="l.unitPrice"
                       (ngModelChange)="onLineChanged(i)"
                       min="0" step="0.0001" />
              </td>

              <!-- Discount -->
              <td class="text-center">
                <input type="number" class="form-control qtInput qtInput--sm qtNum text-center"
                       [(ngModel)]="l.discountPct"
                       (ngModelChange)="onLineChanged(i)"
                       min="0" max="100" step="0.01" />
              </td>

              <!-- Tax Mode -->
              <td>
                <select class="form-control qtInput qtInput--sm"
                        [(ngModel)]="l.taxMode"
                        (ngModelChange)="onLineChanged(i)">
                  <option *ngFor="let m of taxModesForCurrentGst" [ngValue]="m">{{ m }}</option>
                </select>

                <!-- <div class="qtTaxHint" *ngIf="l.taxCodeId">
                  Code: {{ l.taxCodeId }}
                </div> -->
              </td>

              <!-- Fulfillment -->
              <td>
                <select class="form-control qtInput qtInput--sm"
                        [(ngModel)]="l.supplyMethod"
                        (change)="onSupplyMethodChanged(l, i)">
                  <option [ngValue]="null">Select</option>
                  <option [ngValue]="2">Direct DO</option>
                  <option [ngValue]="1">PP</option>
                </select>
              </td>

              <!-- Total -->
              <td class="text-center qtTotal">
                {{ (l.lineTotal || 0) | number:'1.2-2' }}
              </td>

              <!-- Action -->
              <td class="text-center">
                <div class="qtActions">
                  <button class="qtIconBtn qtIconBtn--danger" type="button"
                          (click)="remove(i)"
                          title="Remove">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>

            </tr>

          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== Totals Card ===== -->
  <div class="qtTotals">
    <div class="qtTotals__spacer"></div>

    <div class="qtTotals__card">
      <div class="qtTotalsHead">
        <div class="t">
          <span class="ic"><i class="fas fa-receipt"></i></span>
          <span>Summary</span>
        </div>
        <span class="qtCurrencyPill">
          <span class="k">Currency</span>
          <span class="v">{{ header.currency || '-' }}</span>
        </span>
      </div>

      <div class="qtSumRow">
        <span>Subtotal</span>
        <strong>{{ header.subtotal | currency:header.currency }}</strong>
      </div>

      <div class="qtSumRow qtSumRow--discount">
        <span>Discount</span>

        <div class="qtDiscountBox">
          <input
            type="number"
            class="form-control qtInput qtInput--sm qtNum"
            [(ngModel)]="header.discountInput"
            name="docDiscountInput"
            (ngModelChange)="onDiscountChange()" />

          <select
            class="form-control qtInput qtInput--sm qtDiscType"
            [(ngModel)]="header.discountType"
            name="docDiscountType"
            (change)="onDiscountTypeChange($event.target.value)">
            <option value="VALUE">Amt</option>
            <option value="PERCENT">%</option>
          </select>
        </div>
      </div>

      <div class="qtSumRow">
        <span>Tax</span>
        <strong>{{ header.taxAmount | currency:header.currency }}</strong>
      </div>

      <div class="qtDivider"></div>

      <div class="qtGrand">
        <div class="lhs">
          <span class="k">Grand Total</span>
          <small class="h">Subtotal - Discount + Tax</small>
        </div>
        <h3 class="v">{{ header.grandTotal | currency:header.currency }}</h3>
      </div>
    </div>
  </div>

</div>

<!-- ✅ Bottom Save Bar (sidebar-safe) -->
<div class="qtBottomBar">
  <div class="qtBottomBar__inner">
    <div class="qtBottomBar__left">
      <div class="qtBottomMini">
        <span class="k">Grand Total</span>
        <span class="v">{{ header.grandTotal | currency:header.currency }}</span>
      </div>
    </div>

    <div class="qtBottomBar__right">
      <button class="qtBtn qtBtn--brand qtBtn--bottomSave" type="button" (click)="save()">
        <i class="fas fa-floppy-disk"></i>
        <span>Save Quotation</span>
      </button>
    </div>
  </div>
</div>

<!-- =======================================================
✅ MODAL (FULL)
======================================================= -->
<div *ngIf="showModal" class="qtOverlay" aria-modal="true" role="dialog" (click)="closeModal()">

  <div class="qtModal" (click)="onModalContainer($event)">

    <!-- Header -->
    <div class="qtModal__head">
      <div class="qtModal__title">
        <div class="b"><i class="fas fa-pen-to-square"></i></div>
        <div class="t">
          <div class="h">{{ editingIndex === null ? 'Add Quotation Line' : 'Edit Quotation Line' }}</div>
          <div class="s">Fill details and save changes</div>
        </div>
      </div>

      <button class="qtModal__close" type="button" (click)="closeModal()" aria-label="Close">
        <i class="fas fa-xmark"></i>
      </button>
    </div>

    <!-- Body -->
    <div class="qtModal__body">
      <form (ngSubmit)="submitModal()">

        <div class="qtModalGrid">

          <!-- Item -->
          <div class="qtCol12 qtMd6 position-relative" #modalItemBox>
            <label class="qtLabel">Item</label>

            <div class="qtControl position-relative">
              <input
                #itemSearchInput
                class="qtInput qtInput--withIcon"
                name="itemSearch"
                [(ngModel)]="modal.itemSearch"
                placeholder="Search Item..."
                autocomplete="off"
                (click)="toggleModalItemDropdown()"
                (input)="onModalItemInput()" />

              <button type="button" class="qtDropBtn" (click)="toggleModalItemDropdown()">
                <i class="fas fa-chevron-down"></i>
              </button>

              <div class="qtMenu qtMenu--modal" *ngIf="modal.dropdownOpen">
                <ng-container *ngIf="modal.filteredItems?.length; else noMatches">
                  <div
                    class="qtMi qtMi--split"
                    *ngFor="let row of modal.filteredItems; trackBy: trackByItemId"
                    (mousedown)="$event.preventDefault()"
                    (click)="selectModalItem(row)">
                    <span class="truncate">{{ row.itemName }}</span>
                    <small class="qtMuted">{{ row.itemCode }}</small>
                  </div>
                </ng-container>

                <ng-template #noMatches>
                  <div class="qtMi qtMi--muted">No matches</div>
                </ng-template>
              </div>
            </div>
          </div>

          <!-- Qty -->
          <div class="qtCol12 qtMd3">
            <label class="qtLabel">Qty</label>
            <input
              type="number"
              class="qtInput qtNum"
              [(ngModel)]="modal.qty"
              name="qty"
              min="0"
              step="0.0001"
              (ngModelChange)="previewLineTotals()" />
          </div>

          <!-- UOM -->
          <div class="qtCol12 qtMd3">
            <label class="qtLabel">UOM</label>
            <input class="qtInput" [value]="getUomName(modal.uomId)" placeholder="UOM" readonly />
          </div>

          <!-- Unit Price -->
          <div class="qtCol12 qtMd3">
            <label class="qtLabel">Unit Price</label>
            <input
              type="number"
              class="qtInput qtNum"
              [(ngModel)]="modal.unitPrice"
              name="unitPrice"
              min="0"
              step="0.0001"
              (ngModelChange)="previewLineTotals()" />
          </div>

          <!-- Discount -->
          <div class="qtCol12 qtMd3">
            <label class="qtLabel">Discount %</label>
            <input
              type="number"
              class="qtInput qtNum"
              [(ngModel)]="modal.discountPct"
              name="discountPct"
              min="0"
              max="100"
              step="0.01"
              (ngModelChange)="previewLineTotals()" />
          </div>

          <!-- Tax Mode -->
          <div class="qtCol12 qtMd6">
            <label class="qtLabel">Tax Mode (Line)</label>
            <select
              class="qtInput"
              [(ngModel)]="modal.taxMode"
              name="taxMode"
              (ngModelChange)="previewLineTotals()">
              <option *ngFor="let m of taxModesForCurrentGst" [ngValue]="m">{{ m }}</option>
            </select>

            <div class="qtHelp">
              GST% used:
              <b>{{ modal.taxMode === 'Standard-Rated' ? (header.taxPct || 0) : 0 }}%</b>
            </div>
          </div>

          <!-- Description -->
          <div class="qtCol12">
            <label class="qtLabel">Description</label>
            <textarea
              class="qtInput qtTextarea"
              rows="2"
              [(ngModel)]="modal.description"
              name="description"
              placeholder="Enter description..."></textarea>
          </div>

          <!-- Preview -->
          <div class="qtCol12" *ngIf="modalPreview">
            <div class="qtPreview">
              <div class="r">
                <span>Net</span>
                <strong>{{ modalPreview.net | number:'1.2-2' }}</strong>
              </div>
              <div class="r">
                <span>Tax</span>
                <strong>{{ modalPreview.tax | number:'1.2-2' }}</strong>
              </div>
              <div class="r r--total">
                <span>Total</span>
                <strong>{{ modalPreview.total | number:'1.2-2' }}</strong>
              </div>
            </div>
          </div>

        </div>

        <!-- Footer (sticky) -->
        <div class="qtModal__foot">
          <button type="button" class="qtBtn qtBtn--ghost" (click)="closeModal()">
            Close
          </button>

          <button type="submit" class="qtBtn qtBtn--brand qtBtn--saveModal">
            <i class="fas fa-check"></i>
            <span>{{ editingIndex !== null ? 'Save Changes' : 'Add & Close' }}</span>
          </button>
        </div>

      </form>
    </div>

  </div>
</div>