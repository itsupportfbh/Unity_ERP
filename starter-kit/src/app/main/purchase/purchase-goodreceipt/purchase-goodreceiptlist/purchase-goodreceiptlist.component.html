<div class="content-wrapper p-0">
  <div class="content-body">
    <section class="users-list-wrapper">
      <div class="card">

        <!-- Header row -->
        <div class="row">
          <!-- Title + page size -->
          <div class="col-md-6 col-12">
            <h4 class="card-text ml-2 mt-2"
                style="font-size:1.25rem;font-weight:600;color:#2E5F73">
              GRN List
            </h4>

            <div class="d-flex justify-content-between align-items-center m-1">
              <label class="d-flex align-items-center">
                Show
                <select class="form-control mx-2" [(ngModel)]="selectedOption">
                  <option [ngValue]="10">10</option>
                  <option [ngValue]="25">25</option>
                  <option [ngValue]="50">50</option>
                  <option [ngValue]="100">100</option>
                </select>
                entries
              </label>
            </div>

            <!-- optional lock info -->
            <div *ngIf="isPeriodLocked"
                 class="alert alert-warning py-1 px-2 mx-2 mb-2"
                 style="font-size: 0.8rem;">
              Period <strong>{{ periodName || 'current' }}</strong> is locked.
            </div>
          </div>

          <!-- Search + Create GRN -->
          <div class="col-md-6 col-12 d-flex justify-content-start justify-content-md-end">
            <div class="d-flex align-items-center justify-content-end pr-1 pb-1 pb-md-0">
              <label class="d-flex align-items-center ml-1 ml-md-0">
                Search:
                <input
                  [(ngModel)]="searchValue"
                  type="search"
                  class="form-control ml-2"
                  (keyup)="filterUpdate($event)" />
              </label>

              <button
                (click)="goToCreateGRN()"
                class="btn m-1 d-inline-flex align-items-center"
                style="background-color:#2E5F73; color:white; gap:6px;"
                [disabled]="isPeriodLocked"
                [attr.title]="isPeriodLocked
                               ? (periodName ? 'Period ' + periodName + ' is locked'
                                             : 'Period is locked')
                               : 'Create GRN'">
                <i class="fas fa-plus-circle"></i>
                <span>Create GRN</span>
              </button>
            </div>
          </div>
        </div>

        <!-- NGX DATATABLE -->
        <ngx-datatable
          class="bootstrap core-bootstrap grn-table"
          [rows]="rows"
          [rowHeight]="50"
          [headerHeight]="50"
          [footerHeight]="50"
          [limit]="selectedOption"
          [columnMode]="ColumnMode.force"
          [scrollbarH]="false"
          [reorderable]="true">

          <!-- Eye column -->
          <ngx-datatable-column
            [width]="60"
            [resizeable]="false"
            [sortable]="false"
            [draggable]="false"
            [canAutoResize]="false">
            <ng-template ngx-datatable-cell-template let-row="row">
              <button class="eye-btn"
                      type="button"
                      (click)="openLinesModal(row)"
                      title="View Lines">
                <i class="fas fa-eye"></i>
              </button>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="GRN No" prop="grnNo" [width]="140"></ngx-datatable-column>
          <ngx-datatable-column name="PO No"  prop="pono"  [width]="160"></ngx-datatable-column>

          <ngx-datatable-column name="Items" prop="itemName" [width]="200">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span class="truncate-20"
                    [title]="row.itemName">
                {{ row.itemName?.slice(0, 20) }}{{ row.itemName?.length > 20 ? '...' : '' }}
              </span>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Supplier Name" prop="name" [width]="200">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span class="truncate-20"
                    [title]="row.name">
                {{ row.name?.slice(0, 20) }}{{ row.name?.length > 20 ? '...' : '' }}
              </span>
            </ng-template>
          </ngx-datatable-column>

          <!-- Status -->
          <ngx-datatable-column name="Status" [width]="140" [sortable]="false">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span class="badge" [ngClass]="statusClass(row)">
                {{ statusText(row) }}
              </span>
            </ng-template>
          </ngx-datatable-column>

          <!-- Action -->
          <ngx-datatable-column
            name="Action"
            [width]="120"
            [sortable]="false"
            [canAutoResize]="false">
            <ng-template let-row="row" ngx-datatable-cell-template>
              <div class="d-flex justify-content-center align-items-center h-100">
                <i class="fas fa-pen"
                   [class.text-primary]="!row.isPostInventory && !isPeriodLocked"
                   [class.icon-disabled]="row.isPostInventory || isPeriodLocked"
                   [attr.title]="row.isPostInventory
                                  ? 'Posted to Inventory (cannot edit)'
                                  : (isPeriodLocked ? 'Period locked' : 'Edit')"
                   style="cursor:pointer;"
                   (click)="onEdit(row)">
                </i>
              </div>
            </ng-template>
          </ngx-datatable-column>
        </ngx-datatable>
      </div>
    </section>
  </div>
</div>

<!-- ✅ MEDIUM GRN LINES MODAL (NO SEARCH BAR) -->
<div *ngIf="showLinesModal" class="grnM" (click)="closeLinesModal()">
  <div class="grnM__dialog" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="grnM__header">
      <div class="grnM__title">
        <div class="ttl">GRN Lines</div>
        <div class="sub">
          <span class="dot"></span>
          <span>{{ modalHeader.grnNo || '-' }}</span>
        </div>
      </div>

      <button type="button" class="grnM__x" aria-label="Close" (click)="closeLinesModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Compact meta -->
    <div class="grnM__meta">
      <div class="chip">
        <i class="fas fa-receipt"></i>
        <span class="v">{{ modalHeader.pono || '-' }}</span>
      </div>

      <div class="chip chip--wide" [title]="modalHeader.name || ''">
        <i class="fas fa-truck-loading"></i>
        <span class="v">{{ modalHeader.name || '-' }}</span>
      </div>

      <div class="chip">
        <i class="far fa-calendar-alt"></i>
        <span class="v">{{ modalHeader.receptionDate | date:'yyyy-MM-dd' }}</span>
      </div>
    </div>

    <!-- Body -->
    <div class="grnM__body">
      <div class="tbl">
        <table class="tbl__t">
          <thead>
            <tr>
              <th class="c-item">Item</th>
              <th class="c-wh">Warehouse</th>
              <th class="c-bin">Bin</th>
              <th class="c-stg">Strategy</th>
              <th class="c-qty">Qty</th>
              <th class="c-qc">QC</th>
              <th class="c-batch">Batch/Serial</th>
              <th class="c-sup">Supplier</th>
              <th class="c-sto">Storage</th>
              <th class="c-sur">Surface</th>
              <th class="c-exp">Expiry</th>
              <th class="c-pest">Pest</th>
              <th class="c-dry">Dry/Spill</th>
              <th class="c-odor">Odor</th>
              <th class="c-veh">Vehicle</th>
              <th class="c-def">Defect</th>
              <th class="c-dmg">Damaged</th>
              <th class="c-time">Time</th>
              <th class="c-status">Status</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let l of modalLines; let i=index; trackBy: trackByIdx">
              <td class="cell-item">
                <div class="item-main">{{ l.itemName || l.itemCode || '—' }}</div>
                <div class="item-sub" *ngIf="l.itemCode && l.itemName">{{ l.itemCode }}</div>
              </td>

              <td>{{ l.warehouseName || '—' }}</td>
              <td>{{ l.binName || '—' }}</td>
              <td>{{ l.strategyName || '—' }}</td>
              <td class="num">{{ l.qtyReceived ?? 0 }}</td>
              <td>{{ l.qualityCheck || '—' }}</td>
              <td>{{ l.batchSerial || '—' }}</td>
              <td>{{ l.supplierName || '—' }}</td>
              <td>{{ l.storageType || '—' }}</td>
              <td>{{ l.surfaceTemp || '—' }}</td>
              <td>{{ l.expiry | date:'yyyy-MM-dd' }}</td>
              <td>{{ l.pestSign || '—' }}</td>
              <td>{{ l.drySpillage || '—' }}</td>
              <td>{{ l.odor || '—' }}</td>
              <td>{{ l.plateNumber || '—' }}</td>
              <td>{{ l.defectLabels || '—' }}</td>
              <td>{{ l.damagedPackage || '—' }}</td>
              <td>{{ l.timeText || (l.time | date:'HH:mm') }}</td>

              <td>
                <span class="pill"
                      [ngClass]="l.isFlagIssue ? 'pill--flag' : (l.isPostInventory ? 'pill--post' : 'pill--pend')">
                  {{ l.isFlagIssue ? 'Flagged' : (l.isPostInventory ? 'Posted' : 'Pending') }}
                </span>
              </td>
            </tr>

            <tr *ngIf="!modalLines?.length">
              <td colspan="19" class="empty">No lines</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div class="grnM__footer">
      <div class="count">{{ modalLines?.length || 0 }} line(s)</div>

      <button type="button" class="btnClose" (click)="closeLinesModal()">
        <i class="fas fa-times-circle"></i>
        Close
      </button>
    </div>

  </div>
</div>

<!-- Image Viewer -->
<div *ngIf="imageViewer.open" class="img-modal" (click)="closeImage()">
  <div class="img-modal__backdrop"></div>
  <div class="img-modal__dialog" (click)="$event.stopPropagation()">
    <div class="img-modal__header">
      <h5 class="m-0">Preview</h5>
      <button type="button" class="btn btn-light btn-sm"
              (click)="closeImage()" aria-label="Close">✕</button>
    </div>
    <div class="img-modal__body">
      <img [src]="imageViewer.src" alt="Preview" class="img-fluid" />
    </div>
    <div class="img-modal__footer">
      <button type="button" class="btn btn-primary btn-sm" (click)="closeImage()">Close</button>
    </div>
  </div>
</div>