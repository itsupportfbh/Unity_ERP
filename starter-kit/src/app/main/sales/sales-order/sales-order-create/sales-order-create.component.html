<!-- sales-order-create.component.html -->
<div class="so-page pr-typography">
  <div class="bg-white rounded-2xl shadow px-3 pt-3 pb-6 border border-gray-100 so-card">

    <!-- Header -->
    <div class="so-head">
      <h2 class="title">{{ editMode ? 'Edit Sales Order' : 'Sales Order' }}</h2>
    </div>

    <!-- Header fields -->
    <div [ngClass]="gridColsClass(4)" class="so-grid">

      <!-- Quotation -->
      <div class="so-header-dd dropdown-input">
        <label class="lbl">Quotation No</label>
        <div class="relative">
          <input type="text" class="so-inp"
                 [(ngModel)]="searchTexts['quotationNo']"
                 (input)="!editMode && filter('quotationNo')"
                 (focus)="!editMode && toggleDropdown('quotationNo', true)"
                 placeholder="Search Quotation No..."
                 [disabled]="editMode"/>
          <button *ngIf="searchTexts['quotationNo'] && !editMode" type="button"
                  (click)="onClearSearch('quotationNo')" class="btn-clear">✕</button>
          <button type="button"
                  (click)="!editMode && toggleDropdown('quotationNo')"
                  class="btn-caret" [disabled]="editMode">▼</button>
        </div>

        <ul *ngIf="dropdownOpen['quotationNo'] && !editMode" class="dropdown">
          <li *ngFor="let c of filteredLists['quotationNo']" (click)="select('quotationNo', c)">
            {{ c.number }}
          </li>
        </ul>
      </div>

      <!-- Customer -->
      <div class="so-header-dd">
        <label class="lbl">Customer</label>
        <input type="text" class="so-inp" disabled [(ngModel)]="searchTexts['customer']"/>
      </div>

      <!-- Source Line (readonly) -->
      <div>
        <label class="lbl">Source Line</label>
        <input class="so-inp" type="text" [value]="sourceLineText" disabled />
      </div>

      <!-- Item Set chips (header) -->
      <div *ngIf="showItemSetBox" class="md:col-span-2">
        <label class="lbl">Item Set Name</label>

        <div class="so-inp so-chipbox" title="{{ itemSetNamesText }}">
          <ng-container *ngIf="soHdr.itemSets?.length; else noItemSet">
            <span class="so-chip" *ngFor="let s of soHdr.itemSets">
              {{ s.name }}
            </span>
          </ng-container>

          <ng-template #noItemSet>
            <span class="dim">—</span>
          </ng-template>
        </div>
      </div>

      <!-- GST -->
      <div>
        <label class="lbl">GST (%)</label>
        <input class="so-inp" type="text" disabled [(ngModel)]="soHdr.gstPct"/>
      </div>

      <!-- Requested Date -->
      <div>
        <label class="lbl">Requested Date</label>
        <input class="so-inp so-inp-readonly" type="date"
               [(ngModel)]="soHdr.requestedDate" [min]="todayStr"
               disabled [ngModelOptions]="{ standalone: true }"/>
      </div>

      <!-- Delivery Date -->
      <div class="col-span-1 md:col-span-1">
        <label class="lbl">Delivery Date</label>
        <div class="field-stack">
          <input class="so-inp"
                 type="date"
                 [(ngModel)]="soHdr.deliveryDate"
                 [ngModelOptions]="{ standalone: true }"
                 readonly />
        </div>
      </div>

      <!-- Delivery To -->
      <div class="md:col-span-2">
        <label class="lbl">Delivery To</label>
        <textarea
          class="so-inp so-textarea"
          rows="3"
          [(ngModel)]="soHdr.deliveryTo"
          placeholder="Delivery address / site / contact person"></textarea>
      </div>

      <!-- Remarks -->
      <div class="md:col-span-2">
        <label class="lbl">Remarks</label>
        <textarea
          class="so-inp so-textarea"
          rows="3"
          [(ngModel)]="soHdr.remarks"
          placeholder="Any remarks..."></textarea>
      </div>
    </div>

    <!-- ======================= GROUPED TABLE (2nd image) ======================= -->
    <div class="table-wrap mt-4">
      <table class="so-table so-table--grouped">
        <thead>
          <tr>
            <th class="col-item">ITEM / SET</th>
            <th class="col-desc">DESCRIPTION</th>
            <th class="col-uom">UOM</th>
            <th class="col-qty num">QTY</th>
            <th class="col-price num">UNIT PRICE</th>
            <th class="col-disc num">DISCOUNT %</th>
            <th class="col-tax">TAX MODE</th>
            <th class="col-total num">LINE TOTAL</th>
            <th class="col-act text-right">ACTION</th>
          </tr>
        </thead>

        <tbody>
          <!-- Empty -->
          <tr *ngIf="!setGroups?.length">
            <td class="empty" [attr.colspan]="9">No lines yet.</td>
          </tr>

          <ng-container *ngFor="let g of setGroups">

            <!-- ✅ SET HEADER -->
            <tr class="set-row">
              <td class="set-cell" colspan="8">
                <div class="set-left">
                  <span class="set-ico" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 2 3 7l9 5 9-5-9-5Z" fill="currentColor" opacity=".35"/>
                      <path d="M3 12l9 5 9-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <path d="M3 17l9 5 9-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <span class="set-name">{{ g.name }}</span>
                </div>
              </td>

              <td class="set-action text-right">
                <button type="button" class="btn-set-remove" (click)="removeSet(g)">
                  <span class="ico-trash" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M3 6h18M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 6l1 14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-14"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>
                  Remove Set
                </button>
              </td>
            </tr>

            <!-- ✅ ITEMS under set -->
            <tr class="item-row" *ngFor="let ln of g.lines; trackBy: trackByLineId">

              <td class="td-item">
                <div class="item-text">{{ ln.item }}</div>
              </td>

              <td>
                <input class="so-inp so-inp--line"
                       [(ngModel)]="ln.description"
                       placeholder="-"
                       [disabled]="editMode">
              </td>

              <td>
                <input class="so-inp so-inp--line so-inp--uom"
                       [(ngModel)]="ln.uom"
                       placeholder="UOM"
                       [disabled]="editMode">
              </td>

              <td class="num">
                <input type="number"
                       class="so-inp so-inp--line so-inp--qty text-right"
                       [(ngModel)]="ln.quantity"
                       (input)="onQtyChangeByRef(ln)">
              </td>

              <td class="num">
                <input type="number"
                       class="so-inp so-inp--line so-inp--price text-right"
                       [(ngModel)]="ln.unitPrice"
                       (input)="onUnitPriceChangeByRef(ln)"
                       min="0" step="0.01">
              </td>

              <td class="num">
                <input type="number"
                       class="so-inp so-inp--line so-inp--disc text-right"
                       [(ngModel)]="ln.discount"
                       (input)="onDiscountChangeByRef(ln)"
                       placeholder="0">
              </td>

              <td>
                <div class="tax-dd">
                  <select class="so-inp so-inp--line so-inp--tax"
                          [(ngModel)]="ln.tax"
                          (change)="onTaxChangeByRef(ln)">
                    <option value="Standard-Rated">Standard-Rated</option>
                    <option value="Zero-Rated">Zero-Rated</option>
                    <option value="Exempt">Exempt</option>
                  </select>
                  <span class="tax-caret">▾</span>
                </div>
              </td>

              <td class="num">
                <span class="line-total">{{ (ln.total || 0) | number:'1.2-2' }}</span>
              </td>

              <td class="text-right">
                <button type="button" class="btn-icon-trash" (click)="removeLineFromSet(g, ln)" aria-label="Remove line">
                  <svg viewBox="0 0 24 24">
                    <path d="M3 6h18M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M7 6l1 14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-14"
                          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </td>

            </tr>
          </ng-container>

          <!-- Add line -->
          <tr class="addline-row">
            <td colspan="9">
              <button type="button" class="btn-addline" (click)="addLine()">
                + Add line
              </button>
            </td>
          </tr>

        </tbody>
      </table>
    </div>

    <!-- Summary -->
    <div class="sum-grid">
      <div class="sum-grid-spacer"></div>

      <aside class="mini-total-card mtc-spaced">
        <div class="mtc-row">
          <span class="mtc-label">Sub Total</span>
          <input class="so-inp mtc-inp text-right" type="text"
                 [value]="(totals.subTotal || 0) | number:'1.2-2'" readonly>
        </div>

        <div class="mtc-row">
          <span class="mtc-label">Tax (GST)</span>
          <input class="so-inp mtc-inp text-right" type="text"
                 [value]="(totals.gstAmount || 0) | number:'1.2-2'" readonly>
        </div>

        <div class="mtc-row">
          <span class="mtc-label">Net Total</span>
          <span class="mtc-amt">{{ totals.netTotal | number:'1.2-2' }}</span>
        </div>
      </aside>
    </div>

  </div>

    <div class="sticky-actions">
    <div class="container">
      <button type="button" class="so-btn so-btn-primary" (click)="post()">
        {{ editMode ? 'Update' : 'Save' }}
      </button>

      <button type="button" class="so-btn so-btn-danger" (click)="cancel()">
        Cancel
      </button>
    </div>
  </div>
</div>