<div class="poX">

  <!-- HEADER BAR -->
  <div class="poHdrX">
    <!-- Left -->
    <button class="poHdrX__back" type="button" (click)="goToPurchaseorder()">
      <i class="fas fa-arrow-left"></i>
      <span>Go to PO list</span>
    </button>

    <!-- Center -->
    <div class="poHdrX__center">
      <div class="poHdrX__title">Purchase Order</div>
    </div>

    <!-- Right -->
    <div class="poHdrX__right">
      <div class="poHdrX__badges">
        <div class="pillBadge">
          <span class="k">Currency</span>
          <span class="v">{{ poHdr.currencyName || '-' }}</span>
        </div>
        <div class="pillBadge">
          <span class="k">GST %</span>
          <span class="v">{{ poHdr.tax || 0 }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CARD -->
  <div class="poX__card">

    <!-- SECTION: HEADER -->
    <div class="sec">

      <!-- ROW 1 -->
      <div class="grid3">

        <!-- Supplier -->
        <div class="field dd dropdown-scope" (click)="$event.stopPropagation()">
          <label>Supplier <span class="req">*</span></label>

          <div class="ig">
            <input
              type="text"
              [(ngModel)]="searchTexts['supplier']"
              (input)="filter('supplier')"
              (focus)="toggleDropdown('supplier', true, $event)"
              placeholder="Search supplier..."
            />
            <button *ngIf="searchTexts['supplier']" type="button" class="ig__btn"
              (click)="onClearSearch('supplier'); $event.stopPropagation()"
              title="Clear">âœ•</button>

            <button type="button" class="ig__btn ig__btn--caret"
              (click)="toggleDropdown('supplier', undefined, $event)"
              title="Open">â–¼</button>
          </div>

          <div *ngIf="submitted && isEmpty(searchTexts['supplier'])" class="err">Supplier is required.</div>

          <ul *ngIf="dropdownOpen['supplier']" class="menu" (click)="$event.stopPropagation()">
            <li *ngFor="let item of filteredLists['supplier']"
                (click)="select('supplier', item); $event.stopPropagation()">
              <div class="m1">{{ item.name }}</div>
            </li>
          </ul>
        </div>

        <!-- Payment Terms -->
        <div class="field dd dropdown-scope" (click)="$event.stopPropagation()">
          <label>Payment Terms <span class="req">*</span></label>

          <div class="ig">
            <input
              type="text"
              [(ngModel)]="searchTexts['paymentTerms']"
              (input)="filter('paymentTerms')"
              (focus)="toggleDropdown('paymentTerms', true, $event)"
              placeholder="Search payment terms..."
            />
            <button *ngIf="searchTexts['paymentTerms']" type="button" class="ig__btn"
              (click)="onClearSearch('paymentTerms'); $event.stopPropagation()"
              title="Clear">âœ•</button>

            <button type="button" class="ig__btn ig__btn--caret"
              (click)="toggleDropdown('paymentTerms', undefined, $event)"
              title="Open">â–¼</button>
          </div>

          <div *ngIf="submitted && isEmpty(searchTexts['paymentTerms'])" class="err">Payment Terms is required.</div>

          <ul *ngIf="dropdownOpen['paymentTerms']" class="menu" (click)="$event.stopPropagation()">
            <li *ngFor="let item of filteredLists['paymentTerms']"
                (click)="select('paymentTerms', item); $event.stopPropagation()">
              <div class="m1">{{ item.paymentTermsName }}</div>
            </li>
          </ul>
        </div>

        <!-- Currency / FX -->
        <div class="field">
          <label>Currency / FX Rate</label>

          <div class="split">
            <div class="ig ig--disabled">
              <input type="text" [(ngModel)]="searchTexts['currency']" placeholder="Currency" disabled />
              <button type="button" class="ig__btn ig__btn--caret" disabled>â–¼</button>
            </div>

            <div class="ig">
              <input
                type="number"
                [(ngModel)]="poHdr.fxRate"
                placeholder="FX Rate"
                (input)="calculateFxTotal()"
                [disabled]="isSGDCurrency()"
              />
            </div>
          </div>
        </div>

      </div>

      <!-- ROW 2 -->
      <div class="grid4 mt12">

        <!-- Incoterms -->
        <div class="field dd dropdown-scope" (click)="$event.stopPropagation()">
          <label>Incoterms <span class="muted">(Overseas Only)</span></label>

          <div class="ig" [ngClass]="isSGDCurrency() ? 'ig--disabled' : ''">
            <input
              type="text"
              [(ngModel)]="searchTexts['incoterms']"
              (input)="filter('incoterms')"
              (focus)="toggleDropdown('incoterms', true, $event)"
              placeholder="Search incoterms..."
              [disabled]="isSGDCurrency()"
            />
            <button *ngIf="searchTexts['incoterms']" type="button" class="ig__btn"
              (click)="onClearSearch('incoterms'); $event.stopPropagation()"
              [disabled]="isSGDCurrency()" title="Clear">âœ•</button>

            <button type="button" class="ig__btn ig__btn--caret"
              (click)="toggleDropdown('incoterms', undefined, $event)"
              [disabled]="isSGDCurrency()" title="Open">â–¼</button>
          </div>

          <ul *ngIf="dropdownOpen['incoterms']" class="menu" (click)="$event.stopPropagation()">
            <li *ngFor="let item of filteredLists['incoterms']"
                (click)="select('incoterms', item); $event.stopPropagation()">
              <div class="m1">{{ item.incotermsName }}</div>
            </li>
          </ul>
        </div>

        <!-- PO Date -->
        <div class="field">
          <label>PO Date <span class="req">*</span></label>
          <div class="ig">
            <input
              #POdateInput
              type="date"
              [(ngModel)]="poHdr.poDate"
              (change)="poDateChange()"
              [min]="minDate"
              (focus)="POdateInput.showPicker()"
              (click)="POdateInput.showPicker()"
            />
          </div>
          <div *ngIf="iserrorPoDate" class="err">PO Date is required.</div>
        </div>

        <!-- Delivery Date -->
        <div class="field">
          <label>Delivery Date <span class="req">*</span></label>
          <div class="ig">
            <input
              #deliveryInput
              type="date"
              [(ngModel)]="poHdr.deliveryDate"
              (change)="deliveryChange()"
              [min]="minDate"
              (focus)="deliveryInput.showPicker()"
              (click)="deliveryInput.showPicker()"
            />
          </div>
          <div *ngIf="iserrorDelivery" class="err">Delivery Date is required.</div>
        </div>

        <!-- GST -->
        <div class="field">
          <label>GST (%)</label>
          <div class="ig ig--disabled">
            <input type="number" [value]="poHdr.tax" placeholder="GST" disabled />
          </div>
        </div>

      </div>

      <!-- ROW 3 -->
      <div class="grid3 mt12">

        <!-- Remarks -->
        <div class="field">
          <label>Remarks</label>
          <div class="ig ig--textarea">
            <textarea rows="2" [(ngModel)]="poHdr.remarks" placeholder="Add remarks..."></textarea>
          </div>
        </div>

        <!-- Outlet -->
        <div class="field dd dropdown-scope" (click)="$event.stopPropagation()">
          <label>Outlet <span class="req" *ngIf="!lockHeaderByPR">*</span></label>

          <div class="ig" [ngClass]="lockHeaderByPR ? 'ig--disabled' : ''">
            <input
              type="text"
              [(ngModel)]="searchTexts['deliveryLoc']"
              (input)="filter('deliveryLoc')"
              (focus)="!lockHeaderByPR && toggleDropdown('deliveryLoc', true, $event)"
              placeholder="Search outlet..."
              [disabled]="lockHeaderByPR"
            />
            <button *ngIf="searchTexts['deliveryLoc'] && !lockHeaderByPR" type="button" class="ig__btn"
              (click)="onClearSearch('deliveryLoc'); $event.stopPropagation()"
              title="Clear">âœ•</button>

            <button type="button" class="ig__btn ig__btn--caret"
              (click)="!lockHeaderByPR && toggleDropdown('deliveryLoc', undefined, $event)"
              [disabled]="lockHeaderByPR" title="Open">â–¼</button>
          </div>

          <div *ngIf="submitted && !lockHeaderByPR && isEmpty(searchTexts['deliveryLoc'])" class="err">Outlet is required.</div>

          <ul *ngIf="dropdownOpen['deliveryLoc'] && !lockHeaderByPR" class="menu" (click)="$event.stopPropagation()">
            <li *ngFor="let item of filteredLists['deliveryLoc']"
                (click)="select('deliveryLoc', item); $event.stopPropagation()">
              <div class="m1">{{ item.name }}</div>
              <div class="m2">{{ item.contactNumber || '' }}</div>
            </li>
          </ul>
        </div>

        <!-- Contact -->
        <div class="field">
          <label>Contact Number</label>
          <div class="ig" [ngClass]="lockHeaderByPR ? 'ig--disabled' : ''">
            <input
              type="number"
              [(ngModel)]="poHdr.contactNumber"
              placeholder="Enter contact number"
              [disabled]="lockHeaderByPR"
            />
          </div>
          <div class="hint" *ngIf="lockHeaderByPR">Locked because PO lines come from PR</div>
        </div>

      </div>

    </div>

    <!-- SECTION: LINES -->
    <div class="sec">
      <div class="sec__title sec__title--row">
        <div><h2>Line Items</h2></div>

        <button class="btnMain" type="button" (click)="poAddLine()" [disabled]="!mastersLoaded">
          <span class="p">ï¼‹</span> Add line
        </button>
      </div>

      <!-- âœ… IMPORTANT: dropdown clipping fix: tblWrap no scroll, tblScroll has scroll -->
      <div class="tblWrap">
        <div class="tblScroll" (scroll)="refreshOverlayPos()">
          <table class="tbl">
            <thead>
              <tr>
                <th>PR Number</th>
                <th>Item</th>
                <th>Description</th>
                <th>Tax Code</th>
                <th class="num">Qty</th>
                <th class="num">Unit Price</th>
                <th class="num">Disc %</th>
                <th class="num">Tax Amt</th>
                <th class="num">Total</th>
                <th class="act">Action</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngIf="poLines.length === 0">
                <td colspan="10" class="empty">No lines yet. Click <b>Add line</b>.</td>
              </tr>

              <tr *ngFor="let r of poLines; let i = index; trackBy: trackByIndex">

                <!-- PR -->
                <td class="cell ddcell dropdown-scope" (click)="$event.stopPropagation()">
                  <div class="ig ig--cell">
                    <input
                      type="text"
                      [(ngModel)]="poLines[i].prNo"
                      (focus)="openDropdown(i, 'prNo', $event)"
                      (click)="openDropdown(i, 'prNo', $event)"
                      (input)="filterOptions(i, 'prNo'); refreshOverlayPos()"
                      placeholder="Search PR..."
                      [disabled]="!mastersLoaded || allPrNos.length === 0"
                    />
                    <button type="button" class="ig__btn ig__btn--caret"
                      (click)="openDropdown(i, 'prNo', $event)">â–¼</button>
                  </div>

                 <div *ngIf="poLines[i].dropdownOpen === 'prNo' 
                            && !(ddOL.open && ddOL.index===i && ddOL.field==='prNo')"
                    (click)="$event.stopPropagation()">
                  <div class="mi" *ngFor="let option of poLines[i].filteredOptions"
                      (click)="selectOption(i, 'prNo', option); $event.stopPropagation()">
                    {{ option.purchaseRequestNo }}
                  </div>
                </div>
                </td>

                <!-- Item -->
                <td class="cell ddcell dropdown-scope" (click)="$event.stopPropagation()">
                  <div class="ig ig--cell" [ngClass]="poLines[i].__fromPR ? 'ig--disabled' : ''">
                    <input
                      type="text"
                      [(ngModel)]="poLines[i].item"
                      (focus)="!poLines[i].__fromPR && openDropdown(i, 'item', $event)"
                      (click)="!poLines[i].__fromPR && openDropdown(i, 'item', $event)"
                      (input)="!poLines[i].__fromPR && filterOptions(i, 'item'); refreshOverlayPos()"
                      placeholder="Search item..."
                      [disabled]="poLines[i].__fromPR === true"
                    />
                    <button *ngIf="!poLines[i].__fromPR" type="button" class="ig__btn ig__btn--caret"
                      (click)="openDropdown(i, 'item', $event)">â–¼</button>
                    <button *ngIf="poLines[i].__fromPR" type="button" class="ig__btn" disabled title="Locked">ðŸ”’</button>
                  </div>

                 <div *ngIf="poLines[i].dropdownOpen === 'item' 
                            && !poLines[i].__fromPR
                            && !(ddOL.open && ddOL.index===i && ddOL.field==='item')"
                    (click)="$event.stopPropagation()">

                  <div class="mi mi--split" *ngFor="let option of poLines[i].filteredOptions"
                      (click)="selectOption(i, 'item', option); $event.stopPropagation()">
                    <span class="c">{{ option.itemCode }}</span>
                    <span class="n">{{ option.itemName }}</span>
                  </div>
                </div>
                </td>

                <!-- Desc -->
                <td class="cell">
                  <div class="ig ig--cell">
                    <input class="numL" [(ngModel)]="poLines[i]['description']" placeholder="Item description" />
                  </div>
                </td>

                <!-- Tax -->
                <td class="cell ddcell dropdown-scope" (click)="$event.stopPropagation()">
                  <div class="ig ig--cell">
                    <input
                      type="text"
                      [(ngModel)]="poLines[i].taxCode"
                      (focus)="openDropdown(i, 'taxCode', $event)"
                      (click)="openDropdown(i, 'taxCode', $event)"
                      (input)="filterOptions(i, 'taxCode'); refreshOverlayPos()"
                      (ngModelChange)="onTaxCodeChange(i)"
                      placeholder="Search tax..."
                    />
                    <button type="button" class="ig__btn ig__btn--caret"
                      (click)="openDropdown(i, 'taxCode', $event)">â–¼</button>
                  </div>

                  <div *ngIf="poLines[i].dropdownOpen === 'taxCode'
                            && !(ddOL.open && ddOL.index===i && ddOL.field==='taxCode')"
                    (click)="$event.stopPropagation()">
                  <div class="mi" *ngFor="let option of poLines[i].filteredOptions"
                      (click)="selectOption(i, 'taxCode', option); $event.stopPropagation()">
                    {{ option.name }}
                  </div>
                </div>
                </td>

                <td class="cell num">
                  <div class="ig ig--cell">
                    <input type="number" class="r" [(ngModel)]="poLines[i]['qty']"
                          placeholder="0" (input)="calculateLineTotal(poLines[i])" />
                  </div>
                </td>

                <td class="cell num">
                  <div class="ig ig--cell">
                    <input type="number" class="r" [(ngModel)]="poLines[i]['price']"
                          placeholder="0.00" (input)="sanitizeNumberInput('price', i); calculateLineTotal(poLines[i])" />
                  </div>
                </td>

                <td class="cell num">
                  <div class="ig ig--cell">
                    <input type="number" class="r" [(ngModel)]="poLines[i]['discount']"
                          placeholder="0" (input)="sanitizeNumberInput('discount', i); calculateLineTotal(poLines[i])" />
                  </div>
                </td>

                <td class="cell num">
                  <div class="ig ig--cell ig--disabled">
                    <input type="number" class="r" [(ngModel)]="poLines[i]['taxAmount']" placeholder="0.00" disabled />
                  </div>
                </td>

                <td class="cell num">
                  <div class="ig ig--cell ig--disabled">
                    <input type="number" class="r" [(ngModel)]="poLines[i]['total']" placeholder="0.00" disabled />
                  </div>
                </td>

                <td class="cell act">
                  <button class="btnDanger" type="button" (click)="poRemoveLine(i)">Remove</button>
                </td>

              </tr>
            </tbody>
          </table>
          <!-- âœ… TABLE OVERLAY DROPDOWN (outside grid) -->
<div
  *ngIf="ddOL.open"
  class="ddOverlay"
  [class.ddOverlay--up]="ddOL.openUp"
  [ngStyle]="{
    left: ddOL.left + 'px',
    top: ddOL.top + 'px',
    width: ddOL.width + 'px'
  }"
  (click)="$event.stopPropagation()"
>
  <!-- PR NO -->
  <ng-container *ngIf="ddOL.field === 'prNo'">
    <div class="mi"
      *ngFor="let option of ddOL.options"
      (click)="selectOption(ddOL.index, 'prNo', option); closeOverlay(); $event.stopPropagation()">
      {{ option.purchaseRequestNo }}
    </div>
  </ng-container>

  <!-- ITEM -->
  <ng-container *ngIf="ddOL.field === 'item'">
    <div class="mi mi--split"
      *ngFor="let option of ddOL.options"
      (click)="selectOption(ddOL.index, 'item', option); closeOverlay(); $event.stopPropagation()">
      <span class="c">{{ option.itemCode }}</span>
      <span class="n">{{ option.itemName }}</span>
    </div>
  </ng-container>

  <!-- TAXCODE -->
  <ng-container *ngIf="ddOL.field === 'taxCode'">
    <div class="mi"
      *ngFor="let option of ddOL.options"
      (click)="selectOption(ddOL.index, 'taxCode', option); closeOverlay(); $event.stopPropagation()">
      {{ option.name }}
    </div>
  </ng-container>

  <div class="ddOverlay__empty" *ngIf="!ddOL.options?.length">No results</div>
</div>
        </div>
      </div>

    </div>

    <!-- BOTTOM: TOTALS + APPROVAL -->
    <div class="bottom bottom--new">

      <!-- Totals -->
      <div class="box box--totals">
        <div class="box__head">
          <div class="box__title">
            <div class="box__t1">Totals</div>
            <div class="box__t2">Summary of amounts</div>
          </div>
          <div class="pill pill--brand">
            {{ poHdr.currencyName || 'SGD' }}
          </div>
        </div>

        <div class="sumList">
          <div class="sumRow">
            <span class="k">Sub Total</span>
            <span class="v">{{ poTotals.subTotal | number:'1.2-2' }}</span>
          </div>

          <div class="sumRow">
            <span class="k">Discount (Lines)</span>
            <span class="v">{{ poTotals.lineDiscountTotal.toFixed(2) }}</span>
          </div>

          <div class="sumRow sumRow--input">
            <span class="k">Discount (absolute)</span>
            <div class="ig ig--mini">
              <input type="number" [(ngModel)]="poHdr.discount" placeholder="0"
                    (keydown)="allowOnlyNumbers($event)" (input)="recalculateTotals()" />
            </div>
          </div>

          <div class="sumRow">
            <span class="k">Tax (Lines)</span>
            <span class="v">{{ poTotals.lineTaxTotal.toFixed(2) }}</span>
          </div>

          <div class="sumRow sumRow--input" *ngIf="showShipping">
            <span class="k">Shipping Cost</span>
            <div class="ig ig--mini">
              <input type="number" [(ngModel)]="poHdr.shipping" placeholder="0"
                    (keydown)="allowOnlyNumbers($event)" (input)="recalculateTotals()" />
            </div>
          </div>

          <div class="sumRow" *ngIf="showShipping">
            <span class="k">Shipping + TaxPctAmt</span>
            <span class="v">{{ poTotals.shippingWithTax.toFixed(2) }}</span>
          </div>

          <div class="sumDivider"></div>

          <div class="sumRow sumRow--net">
            <span class="k">Net Total</span>
            <span class="v v--big">{{ poTotals.netTotal | number:'1.2-2' }} {{ poHdr.currencyName }}</span>
          </div>

          <div class="sumRow" *ngIf="poHdr.currencyName !== 'SGD'">
            <span class="k">Net Total (Base SGD)</span>
            <span class="v">{{ poHdr.netTotalBase | number:'1.2-2' }} SGD</span>
          </div>
        </div>
      </div>

      <!-- Approval -->
      <div class="box box--approval dropdown-scope" (click)="$event.stopPropagation()">
        <div class="box__head">
          <div class="box__title">
            <div class="box__t1">Approval</div>
            <div class="box__t2">Select level & take action</div>
          </div>
          <div class="pill pill--soft">Pending</div>
        </div>

        <div class="approvalGrid">

          <!-- Dropdown -->
          <div class="field dd dropdown-scope" (click)="$event.stopPropagation()">
            <label>Approval Level <span class="req">*</span></label>

            <div class="ig">
              <input
                type="text"
                [(ngModel)]="searchTexts['approval']"
                (input)="filter('approval')"
                (focus)="toggleDropdown('approval', true, $event)"
                placeholder="Search approval..."
              />
              <button *ngIf="searchTexts['approval']" type="button" class="ig__btn"
                (click)="onClearSearch('approval'); $event.stopPropagation()"
                title="Clear">âœ•</button>
              <button type="button" class="ig__btn ig__btn--caret"
                (click)="toggleDropdown('approval', undefined, $event)"
                title="Open">â–¼</button>
            </div>

            <div *ngIf="submitted && isEmpty(searchTexts['approval'])" class="err">Approval Level is required.</div>

            <ul *ngIf="dropdownOpen['approval']" class="menu menu--up" (click)="$event.stopPropagation()">
              <li *ngFor="let item of filteredLists['approval']"
                  (click)="select('approval', item); $event.stopPropagation()">
                <div class="m1">{{ item.name }}</div>
              </li>
            </ul>
          </div>

          <!-- Icon action bar -->
          <div class="actionBar actionBar--icons">
            <button class="iconBtn iconBtn--warn" type="button"
              (click)="setApprovalStatus(1)" [disabled]="disabledButton"
              title="Pending" aria-label="Pending">
              <i class="fas fa-hourglass-half"></i>
            </button>

            <button class="iconBtn iconBtn--ok" type="button"
              (click)="setApprovalStatus(2)" [disabled]="disabledButton"
              title="Approve" aria-label="Approve">
              <i class="fas fa-check-circle"></i>
            </button>

            <button class="iconBtn iconBtn--danger" type="button"
              (click)="setApprovalStatus(3)"
              title="Reject" aria-label="Reject">
              <i class="fas fa-ban"></i>
            </button>

            <button class="iconBtn iconBtn--cancel" type="button"
              (click)="cancel()"
              title="Cancel" aria-label="Cancel">
              <i class="fas fa-times"></i>
            </button>
          </div>

        </div>
      </div>

    </div>

  </div>
</div>