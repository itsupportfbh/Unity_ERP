<!-- =================== CREATE MODE (ENTRY FORM) =================== -->
<div *ngIf="!isEditMode && !showSummary" class="grn-ui">

  <!-- Topbar -->
  <div class="grn-topbar grn-topbar-3col">

    <!-- LEFT -->
    <div class="tb-left">
      <button class="grn-btn grn-btn-ghost" type="button" (click)="goToDebitNoteList()">
        <i class="fa fa-arrow-left"></i>
        <span>Go to GRN list</span>
      </button>
    </div>

    <!-- CENTER -->
    <div class="tb-center">
      <div class="grn-title-wrap">
        <div class="grn-title">Goods Receipt (GRN)</div>
        <div class="grn-subtitle">Create GRN from Purchase Order and post inventory line-wise</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="tb-right">
      <button type="button"
              class="grn-btn grn-btn-primary"
              (click)="saveGRN()"
              [disabled]="isPostInventoryDisabled">
        <i *ngIf="!editingGrnId" class="fa fa-save"></i>
        <i *ngIf="editingGrnId" class="fa fa-edit"></i>
        <span>{{ editingGrnId ? 'Update GRN' : 'Save GRN' }}</span>
      </button>
    </div>

  </div>

  <!-- Header Card -->
  <div class="grn-card">
    <div class="grn-card-hdr">
      <div class="grn-card-title">Header Details</div>
      <div class="grn-badges">
        <span class="grn-badge grn-badge-muted">Mode: Create</span>
        <span class="grn-badge grn-badge-warn" *ngIf="isPostInventoryDisabled">Posting locked</span>
      </div>
    </div>

    <div class="grn-form-grid">
      <!-- From PO -->
      <div class="grn-field">
        <label>From PO</label>

        <div class="grn-select-wrap">
          <select [(ngModel)]="selectedPO"
                  (ngModelChange)="onPOChange($event)"
                  class="grn-ctl grn-ctl-select">
            <option [ngValue]="null" disabled>Select PO</option>
            <ng-container *ngFor="let po of purchaseOrder">
              <option [ngValue]="po.id">{{ po.purchaseOrderNo }} - {{ po.supplierName }}</option>
            </ng-container>
          </select>
          <i class="fa fa-chevron-down grn-select-icon"></i>
        </div>
      </div>

      <!-- PO Date -->
      <div class="grn-field" (click)="!isPoDateDisabled && dateInput.showPicker()">
        <label>PO Date</label>
        <input #dateInput
               type="date"
               [(ngModel)]="receiptDate"
               [disabled]="isPoDateDisabled"
               [readOnly]="isPoDateDisabled"
               [min]="minDate"
               class="grn-ctl"
               [class.grn-disabled]="isPoDateDisabled" />
      </div>

      <!-- âœ… NEW: Invoice Number -->
 <!-- âœ… Invoice Number -->
<div class="grn-field">
  <label>Invoice Number</label>
  <input type="text"
         [(ngModel)]="invoiceNo"
         placeholder="Enter supplier invoice number"
         class="grn-ctl"
         maxlength="50" />
</div>

      <!-- Over Receipt -->
      <div class="grn-field">
        <label>Over-receipt Tolerance (%)</label>
        <input type="number"
               min="0"
               max="5"
               placeholder="0"
               [(ngModel)]="overReceiptTolerance"
               (keypress)="allowOnlyNumbers($event)"
               class="grn-ctl" />
      </div>
    </div>
  </div>

  <!-- Lines Card -->
  <div class="grn-card">
    <div class="grn-card-hdr">
      <div class="grn-card-title">Receipt Lines</div>
      <div class="grn-actions">
        <span class="grn-chip">Lines: {{ grnRows?.length || 0 }}</span>
        <span class="grn-chip grn-chip-info">Initial: {{ currentUsername }}</span>
      </div>
    </div>

    <div class="grn-table-wrap">
      <table class="grn-table">
        <thead>
          <tr>
            <th class="sticky-col th-item">Item / Product</th>
            <th class="th-supplier">Supplier</th>
            <th>Warehouse</th>
            <th>Bin</th>
            <th>Frequency</th>
            <th>Batch / Serial</th>
            <th class="th-num">Qty Received</th>
            <th>Partial</th>
            <th>Quality Check</th>
            <th>Frozen/Chilled/Dry</th>
            <th class="th-num">Surface Temp</th>
            <th>Expiry</th>
            <th>Pest / Sign</th>
            <th>Dry / Spillage</th>
            <th>Odor</th>
            <th>Vehicle #</th>
            <th>Defective Labels</th>
            <th>Damaged Package</th>
            <th>Time</th>
            <th>Initial</th>
            <th>Remarks</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of grnRows; let i = index; trackBy: trackByIndex">

            <!-- Item -->
            <td class="sticky-col td-item">
              <div class="grn-itemcell">
                <div class="code">{{ r.itemCode || '' }}</div>
                <div class="name">{{ r.itemName || r.itemText || '' }}</div>
              </div>
            </td>

            <!-- Supplier -->
            <td class="td-supplier">
              <div class="grn-itemcell">
                <div class="name">{{ r.supplierName || '' }}</div>
              </div>
            </td>

            <!-- Warehouse -->
            <td class="w-240">
              <ng-select
                [items]="warehouses"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="r.warehouseId"
                (change)="onWarehouseChange(r)"
                [appendTo]="'body'"
                [dropdownPosition]="'bottom'"
                [clearable]="true"
                placeholder="Select Warehouse"
                class="grn-ng">
              </ng-select>
            </td>

            <!-- Bin -->
            <td class="w-240">
              <ng-select
                [items]="getBins(r.warehouseId)"
                bindLabel="binName"
                bindValue="id"
                [(ngModel)]="r.binId"
                (change)="r.binName = lookupBinName(r.binId)"
                [appendTo]="'body'"
                [dropdownPosition]="'bottom'"
                [searchable]="true"
                [clearable]="true"
                placeholder="Select Bin"
                class="grn-ng">
              </ng-select>
            </td>

            <!-- Frequency -->
            <td class="w-240">
              <ng-select
                [items]="strategies"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="r.strategyId"
                (change)="r.strategyName = lookupStrategyName(r.strategyId)"
                [appendTo]="'body'"
                [dropdownPosition]="'bottom'"
                [clearable]="true"
                placeholder="Select Frequency"
                class="grn-ng">
              </ng-select>
            </td>

            <!-- Batch -->
            <td class="w-200">
              <input [(ngModel)]="r.batchSerial"
                     placeholder="Batch / Serial"
                     class="grn-ctl" />
            </td>

            <!-- Qty -->
          <td class="w-150">
  <input type="number"
       min="0"
       [(ngModel)]="r.qtyReceived"
       (ngModelChange)="onQtyChange(r)"
       class="grn-ctl grn-ctl-num" />
</td>
<td class="w-120 grn-center">
 <input type="checkbox"
  [(ngModel)]="r.isPartial"
  [disabled]="!( (r.qtyReceived||0) > 0 && (r.qtyReceived||0) < (r.remainingQty||r.poQty||0) )" />
</td>
            <!-- Quality -->
            <td class="w-200">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.qualityCheck" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option value="pass">Pass</option>
                  <option value="fail">Fail</option>
                  <option value="notverify">Not Verify</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Storage -->
            <td class="w-220">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.storageType" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option value="Frozen">Frozen</option>
                  <option value="Chilled">Chilled</option>
                  <option value="Dry">Dry</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Temp -->
            <td class="w-160">
              <input [(ngModel)]="r.surfaceTemp" placeholder="Â°C" class="grn-ctl grn-ctl-num" />
            </td>

            <!-- Expiry -->
            <td class="w-200" (click)="expiryInput.showPicker()">
              <input #expiryInput type="date" [(ngModel)]="r.expiry" [min]="minDate" class="grn-ctl" />
            </td>

            <!-- Pest -->
            <td class="w-160">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.pestSign" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Dry -->
            <td class="w-180">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.drySpillage" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Odor -->
            <td class="w-160">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.odor" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Vehicle -->
            <td class="w-180">
              <input [(ngModel)]="r.plateNumber" class="grn-ctl" />
            </td>

            <!-- Defect -->
            <td class="w-200">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.defectLabels" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Damaged -->
            <td class="w-200">
              <div class="grn-select-wrap">
                <select [(ngModel)]="r.damagedPackage" class="grn-ctl grn-ctl-select">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
                <i class="fa fa-chevron-down grn-select-icon"></i>
              </div>
            </td>

            <!-- Time -->
            <td class="w-160">
              <input type="time" [(ngModel)]="r.time" class="grn-ctl" />
            </td>

            <!-- Initial -->
            <td class="w-160">
              <input [value]="currentUsername" readonly class="grn-ctl grn-ctl-readonly grn-center" />
            </td>

            <!-- Remarks -->
            <td class="w-280">
              <input [(ngModel)]="r.remarks" class="grn-ctl" />
            </td>

          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>


<!-- =================== CREATE MODE SUMMARY (AFTER SAVE) =================== -->
<div *ngIf="!isEditMode && showSummary && generatedGRN" class="grn-ui grn-summary-ui">

  <div class="grn-topbar grn-topbar-3col">
    <div class="tb-left">
      <button class="grn-btn grn-btn-ghost" type="button" (click)="goToDebitNoteList()">
        <i class="fa fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>

    <div class="tb-center">
      <div class="grn-title-wrap">
        <div class="grn-title">Generated GRN Summary</div>
      </div>
    </div>

    <div class="tb-right grn-topbar-right">
      <span class="grn-badge grn-badge-muted">GRN: {{ generatedGRN.grnNo }}</span>
      <span class="grn-badge grn-badge-muted">PO: {{ generatedGRN.poNo || generatedGRN.poid }}</span>

      <!-- âœ… NEW: Invoice badge -->
      <span *ngIf="generatedGRN?.invoiceNo " class="grn-badge grn-badge-muted">
        Inv: {{ generatedGRN.invoiceNo  }}
      </span>

      <span class="grn-badge grn-badge-info">Total: {{ generatedGRN.grnJson?.length || 0 }}</span>
    </div>
  </div>

  <div class="grn-card">
    <div class="grn-card-hdr">
      <div class="grn-card-title">Lines</div>
      <div class="grn-actions">
        <span class="grn-chip">Pending: {{ (generatedGRN.grnJson?.length || 0) - (postedCount || 0) }}</span>
        <span class="grn-chip grn-chip-ok">Posted: {{ postedCount || 0 }}</span>
      </div>
    </div>

    <div class="grn-table-wrap">
      <table class="grn-table grn-table-summary">
        <thead>
          <tr>
            <th class="sticky-col th-item">Item</th>
            <th class="th-supplier">Supplier</th>
            <th>Warehouse</th>
            <th>Bin</th>
            <th>Frequency</th>
            <th>Batch / Serial</th>
            <th class="th-num">Qty</th>
            <th>Status</th>
            <th class="th-actions">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let row of generatedGRN.grnJson; let i = index">

            <td class="sticky-col td-item">
              <div class="grn-itemcell">
                <div class="code">{{ row.itemCode || '' }}</div>
                <div class="name">{{ row.itemName || row.itemText || '' }}</div>
              </div>
            </td>

            <td class="td-supplier">
              <div class="grn-itemcell">
                <div class="name">{{ row.supplierName || '' }}</div>
              </div>
            </td>

            <td>{{ row.warehouseName || lookupWarehouseName(row.warehouseId) }}</td>
            <td>{{ row.binName || lookupBinName(row.binId) }}</td>
            <td>{{ row.strategyName || lookupStrategyName(row.strategyId) }}</td>
            <td>{{ row.batchSerial }}</td>
            <td class="td-num">{{ row.qtyReceived }}</td>

            <td>
              <span class="grn-pill"
                    [ngClass]="{
                      'pill-red': row.isFlagIssue,
                      'pill-green': !row.isFlagIssue && row.isPostInventory,
                      'pill-gray': !row.isFlagIssue && !row.isPostInventory
                    }">
                {{ row.isFlagIssue ? 'Flagged' : (row.isPostInventory ? 'Posted' : 'Pending') }}
              </span>
            </td>

            <td class="td-actions">
              <button type="button" class="grn-btn grn-btn-warn" (click)="onFlagIssuesRow(row, i)">
                <i class="fa fa-flag"></i><span>Flag</span>
              </button>

              <button type="button"
                      class="grn-btn grn-btn-primary"
                      (click)="onPostInventoryRow(row, i)"
                      [disabled]="isPostInventoryDisabled || row.isPostInventory">
                <i class="fa fa-box"></i><span>Post</span>
              </button>
            </td>

          </tr>
        </tbody>

      </table>
    </div>
  </div>
</div>


<!-- =================== EDIT MODE SUMMARY (EDIT GRN) =================== -->
<div *ngIf="isEditMode && generatedGRN" class="grn-ui grn-summary-ui">

  <div class="grn-topbar grn-topbar-3col">

    <div class="tb-left">
      <button class="grn-btn grn-btn-ghost" type="button" (click)="goToDebitNoteList()">
        <i class="fa fa-arrow-left"></i>
        <span>Back</span>
      </button>
    </div>

    <div class="tb-center">
      <div class="grn-title-wrap">
        <div class="grn-title">Edit GRN</div>
      </div>
    </div>

    <div class="tb-right grn-topbar-right">
      <span class="grn-badge grn-badge-muted">GRN: {{ generatedGRN.grnNo }}</span>
      <span class="grn-badge grn-badge-muted">PO: {{ generatedGRN.poNo || generatedGRN.poid }}</span>

      <!-- âœ… NEW: Invoice badge -->
      <span *ngIf="generatedGRN?.invoiceNo " class="grn-badge grn-badge-muted">
        Inv: {{ generatedGRN.invoiceNo  }}
      </span>

      <span *ngIf="hiddenPostedCount > 0" class="grn-badge grn-badge-warn">
        Posted hidden: {{ hiddenPostedCount }}
      </span>
      <span class="grn-badge grn-badge-info">Lines: {{ editRowsWithIndex?.length || 0 }}</span>
    </div>
  </div>

  <!-- âœ… Edit mode-à®² Invoice Number edit à®ªà®£à¯à®£ à®µà¯‡à®£à¯à®Ÿà¯à®®à¯ à®Žà®©à¯à®±à®¾à®²à¯ à®‡à®¨à¯à®¤ header card-à® add à®ªà®£à¯à®£à®¿à®•à¯à®•à®²à®¾à®®à¯ -->
  <div class="grn-card">
    <div class="grn-card-hdr">
      <div class="grn-card-title">Header</div>
      <div class="grn-actions">
        <span class="grn-chip grn-chip-info">You can edit invoice number here</span>
      </div>
    </div>

    <div class="grn-form-grid">
      <div class="grn-field">
        <label>Invoice Number</label>
        <input type="text"
               [(ngModel)]="invoiceNo"
               placeholder="Enter supplier invoice number"
               class="grn-ctl"
               maxlength="50" />
      </div>

      <div class="grn-field">
        <label>PO Date</label>
        <input type="date"
               [(ngModel)]="receiptDate"
               class="grn-ctl" />
      </div>

      <div class="grn-field">
        <label>Over-receipt Tolerance (%)</label>
        <input type="number"
               min="0"
               max="5"
               placeholder="0"
               [(ngModel)]="overReceiptTolerance"
               (keypress)="allowOnlyNumbers($event)"
               class="grn-ctl" />
      </div>

      <div class="grn-field">
        <button class="grn-btn grn-btn-primary" type="button" (click)="saveGRN()">
          <i class="fa fa-save"></i>
          <span>Update GRN Header</span>
        </button>
      </div>
    </div>
  </div>

  <div class="grn-card">
    <div class="grn-card-hdr">
      <div class="grn-card-title">Editable Lines</div>
      <div class="grn-actions">
        <span class="grn-chip grn-chip-info">Only non-posted lines are editable</span>
      </div>
    </div>

    <div class="grn-table-wrap">
      <table class="grn-table grn-table-summary">
        <thead>
          <tr>
            <th class="sticky-col th-item">Item</th>
            <th class="th-supplier">Supplier</th>
            <th>Warehouse</th>
            <th>Bin</th>
            <th>Frequency</th>
            <th>Batch / Serial</th>
            <th class="th-num">Qty</th>
            <th>Status</th>
            <th class="th-actions">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let x of editRowsWithIndex; trackBy: trackByIndex"
              [class.row-posted]="x.row.isPostInventory">

            <td class="sticky-col td-item">
              <div class="grn-itemcell">
                <div class="code">{{ x.row.itemCode || '' }}</div>
                <div class="name">{{ x.row.itemName || x.row.itemText || '' }}</div>
              </div>
            </td>

            <!-- Supplier editable -->
            <td class="td-supplier w-260">
              <input [(ngModel)]="x.row.supplierName" class="grn-ctl grn-ctl-wide-supplier" />
            </td>

            <!-- Warehouse disabled -->
            <td class="w-240">
              <ng-select
                [items]="warehouses"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="x.row.warehouseId"
                [disabled]="true"
                [clearable]="false"
                [searchable]="false"
                class="grn-ng grn-ng-disabled">
              </ng-select>
            </td>

            <!-- Bin disabled -->
            <td class="w-240">
              <ng-select
                [items]="getBins(x.row.warehouseId)"
                bindLabel="binName"
                bindValue="id"
                [(ngModel)]="x.row.binId"
                [disabled]="true"
                [clearable]="false"
                [searchable]="false"
                class="grn-ng grn-ng-disabled">
              </ng-select>
            </td>

            <!-- Frequency disabled -->
            <td class="w-240">
              <ng-select
                [items]="strategies"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="x.row.strategyId"
                [disabled]="true"
                [clearable]="false"
                [searchable]="false"
                class="grn-ng grn-ng-disabled">
              </ng-select>
            </td>

            <td class="w-200">
              <input [(ngModel)]="x.row.batchSerial" class="grn-ctl" />
            </td>

            <td class="w-150">
              <input type="number" min="0"
                     [(ngModel)]="x.row.qtyReceived"
                     (keypress)="allowOnlyNumbers($event)"
                     class="grn-ctl grn-ctl-num" />
            </td>

            <td>
              <span class="grn-pill"
                    [ngClass]="{
                      'pill-red': x.row.isFlagIssue,
                      'pill-green': !x.row.isFlagIssue && x.row.isPostInventory,
                      'pill-gray': !x.row.isFlagIssue && !x.row.isPostInventory
                    }">
                {{ x.row.isFlagIssue ? 'Flagged' : (x.row.isPostInventory ? 'Posted' : 'Pending') }}
              </span>
            </td>

            <td class="td-actions">
              <button type="button" class="grn-btn grn-btn-warn" (click)="onFlagIssuesRow(x.row, x.idx)">
                <i class="fa fa-flag"></i><span>Flag</span>
              </button>

              <button type="button"
                      class="grn-btn grn-btn-primary"
                      (click)="onPostInventoryRow(x.row, x.idx)"
                      [disabled]="isPostInventoryDisabled || x.row.isPostInventory">
                <i class="fa fa-box"></i><span>Post</span>
              </button>
            </td>

          </tr>
        </tbody>

      </table>
    </div>
  </div>

</div>


<!-- =================== FLAG ISSUES MODAL (âœ… INCLUDED) =================== -->
<div *ngIf="flagModal.open"
     class="grn-modal"
     (keydown.escape)="closeFlagIssuesModal()">

  <div class="grn-modal-backdrop" (click)="closeFlagIssuesModal()"></div>

  <div class="grn-modal-card" role="dialog" aria-modal="true">
    <div class="grn-modal-hdr">
      <div class="grn-modal-title">
        <span class="icon">ðŸš©</span>
        <span>Flag an Issue</span>
      </div>

      <button type="button" class="grn-icon-btn" (click)="closeFlagIssuesModal()" aria-label="Close">
        <span>Ã—</span>
      </button>
    </div>

    <div class="grn-modal-body">
      <label class="grn-modal-label">Select an Issue</label>

      <div class="grn-select-wrap">
        <select [(ngModel)]="selectedFlagIssueId" class="grn-ctl grn-ctl-select">
          <option [ngValue]="null" disabled>Select an issue</option>
          <option *ngFor="let fi of flagIssuesList" [ngValue]="fi.id">
            {{ fi.flagIssuesNames || fi.name || fi.flagIssueName || fi.FlagIssueName }}
          </option>
        </select>
        <i class="fa fa-chevron-down grn-select-icon"></i>
      </div>
    </div>

    <div class="grn-modal-actions">
      <button type="button" class="grn-btn grn-btn-ghost" (click)="closeFlagIssuesModal()">
        <i class="fa fa-times-circle"></i><span>Cancel</span>
      </button>

      <button type="button" class="grn-btn grn-btn-danger" (click)="submitFlagIssue()">
        <i class="fa fa-check-circle"></i><span>Submit</span>
      </button>
    </div>
  </div>
</div>


<!-- =================== IMAGE VIEWER (LIGHTBOX) =================== -->
<div *ngIf="imageViewer.open"
     class="grn-lightbox"
     (click)="closeImage()">
  <img *ngIf="imageViewer.src"
       [src]="imageViewer.src"
       class="grn-lightbox-img" />
</div>